function dataURLtoBlob(a){for(var b=a.split(","),c=b[0].match(/:(.*?);/)[1],d=atob(b[1]),e=d.length,f=new Uint8Array(e);e--;)f[e]=d.charCodeAt(e);return new Blob([f],{type:c})}function midi_statistics(a){function b(a){var b=Object.keys(a),c=b.map(function(b){return a[b]}),d=_.zip(b,c);return d.sort(function(a,b){return b[1]-a[1]}),d}var c={rhythm:{},melody:{one:{},two:{}}},d={},e={},f=0,g=0;return a.forEach(function(a){var b=_.unzip(a),h=b[0];if(c.rhythm[h]=1+(c.rhythm[h]||0),h=b[1],!(h.length<2)){var i=[h[0]%12,(h[1]-h[0])%12];d[i]=1+(d[i]||0),f++;for(var j=2;j<h.length;++j)i=[h[j-1]%12,(h[j]-h[j-1])%12],d[i]=1+(d[i]||0),f++,i=[h[j-2]%12,(h[j-1]-h[j-2])%12,i[1]],e[i]=1+(e[i]||0),g++}}),c={rhythm:b(c.rhythm),melody:{one:b(d),two:b(e),n:[0,f,g]}}}function midi2wav(a,b){function c(a,b,c){var d=MIDI.channels[a],e=d.program;9==a&&(e=128,c*=.75);var f=e+"x"+b,g=MIDI.audioBuffers[f];return null==g?void console.log("no buffer",f):void(n[a+"x"+b]={buffer:g,cur_i:0,vol:c/127,fade_out:-1})}function d(a,c){var d=n[a+"x"+c];if(d){var e=.15*d.vol;d.fade_out=Math.floor(e*b)}}function e(a){if(!(a<=0)){var c=Math.floor(m*b/1e3);for(var d in n){var e=n[d],f=e.buffer.getChannelData(0),g=e.buffer.getChannelData(1),h=e.vol,i=c,j=e.cur_i,o=a;if(j+o>f.length&&(o=f.length-j),e.fade_out<0)for(var p=0;p<o;++p,++i,++j)k[i]+=f[j]*h,l[i]+=g[j]*h;else{var q=h/e.fade_out;e.fade_out<o&&(o=e.fade_out);for(var p=0;p<o;++p,++i,++j)k[i]+=f[j]*h,l[i]+=g[j]*h,h-=q;e.fade_out-=o,e.vol=h}e.cur_i=j,(0==e.fade_out||e.cur_i>=f.length)&&delete n[d]}}}function f(a){if(e(Math.floor(b/1e3*a[1])),m+=a[1],"channel"===a[0].event.type){var f=a[0].event,g=f.channel,h=MIDI.channels[g];switch(f.subtype){case"controller":MIDI.setController(g,f.controllerType,f.value,0);break;case"programChange":MIDI.programChange(g,f.programNumber,0),console.log("to mp3, programChange",f.programNumber);break;case"pitchBend":MIDI.pitchBend(g,f.value,0);break;case"noteOn":if(h.mute)break;c(g,f.noteNumber,f.velocity);break;case"noteOff":if(h.mute)break;d(g,f.noteNumber)}}}var b=b||44100,g=new Replayer(a,1,null),h=g.getData(),i=1e3;h.forEach(function(a){i+=a[1]});var j=Math.floor(b/1e3*i);console.log("length",j);var k=new Float32Array(j),l=new Float32Array(j),m=500,n={};return MIDI.loadPlugin({instruments:MIDI.Player.getFileInstruments(h)},function(){console.log("loadededed")}),h.forEach(f),console.log("midi to mp3 processed"),[k,l]}function getOutputScale(a){var b=window.devicePixelRatio||1,c=a.webkitBackingStorePixelRatio||a.mozBackingStorePixelRatio||a.msBackingStorePixelRatio||a.oBackingStorePixelRatio||a.backingStorePixelRatio||1,d=b/c;return{sx:d,sy:d,scaled:1!==d}}var score_parser=function(){function a(){this.yy={}}var b=function(a,b,c,d){for(c=c||{},d=a.length;d--;c[a[d]]=b);return c},c=[1,18],d=[1,19],e=[1,16],f=[1,17],g=[1,14],h=[1,4,11,12,20,21,42],i=[1,24],j=[1,25],k=[1,26],l=[4,14,15,16],m=[1,36],n=[1,37],o=[1,38],p=[1,39],q=[1,40],r=[1,41],s=[1,42],t=[4,11,12,14,15,16,46],u=[4,14,15,16,23,25,27,29,34,35,36,37,38,39,40],v=[11,12,34,35,36,37,38,39,40,44],w=[4,11,12,14,15,16,34,35,36,37,38,39,40,46],x=[4,11,12,14,15,16,23,24,25,27,29,34,35,36,37,38,39,40,46,47],y=[4,11,12,14,15,16,23,25,27,29,34,35,36,37,38,39,40,44,46],z={trace:function(){},yy:{},symbols_:{error:2,e:3,EOF:4,M:5,Measure:6,melody:7,harmony:8,percussion:9,NUMBER:10,DIGIT:11,DIGITS:12,M_end:13,M_SEP:14,BAR:15,REPEAT_END:16,Note:17,Ctrl:18,C0:19,CTRL_START:20,REPEAT_START:21,C1:22,t:23,"/":24,k:25,KEY:26,Op_string:27,STRING:28,Op_unary:29,P1:30,C:31,Chord:32,P:33,"#":34,FLAT:35,"+":36,"-":37,NATURAL:38,TRILL_UP:39,TRILL_DOWN:40,Pitches:41,CHORD_START:42,Inverse:43,i:44,DUR:45,",":46,"^":47,$accept:0,$end:1},terminals_:{2:"error",4:"EOF",7:"melody",8:"harmony",9:"percussion",11:"DIGIT",12:"DIGITS",14:"M_SEP",15:"BAR",16:"REPEAT_END",20:"CTRL_START",21:"REPEAT_START",23:"t",24:"/",25:"k",26:"KEY",27:"Op_string",28:"STRING",29:"Op_unary",34:"#",35:"FLAT",36:"+",37:"-",38:"NATURAL",39:"TRILL_UP",40:"TRILL_DOWN",42:"CHORD_START",44:"i",46:",",47:"^"},productions_:[0,[3,2],[3,3],[3,2],[3,1],[3,1],[3,1],[3,1],[10,1],[10,1],[6,2],[6,3],[13,1],[13,1],[5,1],[5,1],[5,3],[5,3],[19,1],[19,1],[22,4],[22,2],[22,2],[22,2],[22,1],[31,1],[31,2],[18,1],[18,1],[33,1],[33,2],[30,1],[30,1],[30,1],[30,1],[30,1],[30,1],[30,1],[41,1],[41,2],[32,3],[43,2],[43,2],[43,0],[17,2],[45,2],[45,3],[45,2],[45,0]],performAction:function(a,b,c,d,e,f,g){var h=f.length-1;switch(e){case 1:return this.$=f[h-1],this.$;case 2:return f[h-1].push({ctrl:"normal_end"}),f[h-2].data.push(f[h-1]),this.$=f[h-2],this.$;case 3:f[h-1].data.push(f[h]),this.$=f[h-1];break;case 4:this.$={mode:"melody",data:[f[h]]};break;case 5:this.$={mode:"melody"};break;case 6:this.$={mode:"harmony"};break;case 7:this.$={mode:"percussion"};break;case 8:this.$=parseInt(f[h]);break;case 9:this.$=parseInt(f[h].substr(1,f[h].length-2)),console.log("braket number",this.$);break;case 10:case 39:f[h-1].push(f[h]),this.$=f[h-1];break;case 11:case 16:case 17:f[h-2].push(f[h]),this.$=f[h-2];break;case 12:this.$={ctrl:"normal_end"};break;case 13:this.$={ctrl:"repeat_end"};break;case 14:case 15:case 38:this.$=[f[h]];break;case 18:this.$=["ctrl","reset"];break;case 19:this.$=["ctrl","repeat_start"];break;case 20:this.$=[f[h-3],[f[h-2],f[h]]];break;case 21:this.$=[f[h-1],f[h]];break;case 22:this.$=[f[h-1],f[h].substr(1,f[h].length-2)];break;case 23:this.$=[f[h-1][0],f[h]];break;case 24:this.$=["p",f[h]];break;case 25:this.$={},this.$[f[h][0]]=f[h][1];break;case 26:f[h-1][f[h][0]]=f[h][1],"reset"==f[h-1].ctrl&&(f[h-1].ctrl="normal"),this.$=f[h-1];break;case 27:case 28:case 29:this.$=f[h];break;case 30:"number"==typeof f[h-1]?f[h-1]={original:f[h-1],ornament:[f[h]]}:f[h-1].ornament.push(f[h]),this.$=f[h-1];break;case 31:this.$=1;break;case 32:this.$=-1;break;case 33:this.$=12;break;case 34:this.$=-12;break;case 35:this.$=0;break;case 36:this.$="trill_up";break;case 37:this.$="trill_down";break;case 40:this.$={},this.$.ctrl="chord",this.$.transpose=f[h-1].transpose,this.$.inv=f[h-1].inv,this.$.pitch=f[h];break;case 41:f[h-1].inv+=1,this.$=f[h-1];break;case 42:"number"==typeof f[h]&&(f[h-1].transpose+=f[h]),this.$=f[h-1];break;case 43:this.$={inv:0,transpose:0};break;case 44:this.$={pitch:f[h-1],dur:f[h]};break;case 45:this.$=f[h];break;case 46:this.$={original:f[h-1],ornament:"tie"};break;case 47:this.$={original:1,ornament:"tie"};break;case 48:this.$=1}},table:[{3:1,5:6,6:2,7:[1,3],8:[1,4],9:[1,5],10:15,11:c,12:d,17:7,18:8,19:13,20:e,21:f,31:10,32:11,33:12,41:9,42:g},{1:[3],4:[1,20],5:21,6:22,10:15,11:c,12:d,17:7,18:8,19:13,20:e,21:f,31:10,32:11,33:12,41:9,42:g},b(h,[2,4]),b(h,[2,5]),b(h,[2,6]),b(h,[2,7]),{13:23,14:i,15:j,16:k},b(l,[2,14]),b(l,[2,15]),b(l,[2,48],{10:15,45:27,33:28,11:c,12:d,46:[1,29]}),b(l,[2,27],{22:30,30:35,23:[1,31],25:[1,32],27:[1,33],29:[1,34],34:m,35:n,36:o,37:p,38:q,39:r,40:s}),b(l,[2,28]),b(t,[2,38],{30:43,34:m,35:n,36:o,37:p,38:q,39:r,40:s}),b(u,[2,25]),b(v,[2,43],{43:44}),b(w,[2,29]),b(u,[2,18]),b(u,[2,19]),b(x,[2,8]),b(x,[2,9]),b(h,[2,1]),{4:[1,45],13:23,14:i,15:j,16:k},b(h,[2,3]),b(h,[2,10]),{10:15,11:c,12:d,13:46,15:j,16:k,17:47,18:48,19:13,20:e,21:f,31:10,32:11,33:12,41:9,42:g},b(h,[2,12]),b(h,[2,13]),b(l,[2,44]),b(t,[2,39],{30:43,34:m,35:n,36:o,37:p,38:q,39:r,40:s}),{10:49,11:c,12:d,47:[1,50]},b(u,[2,26]),{10:51,11:c,12:d},{26:[1,52]},{28:[1,53]},{10:54,11:c,12:d},b(u,[2,24]),b(y,[2,31]),b(y,[2,32]),b(y,[2,33]),b(y,[2,34]),b(y,[2,35]),b(y,[2,36]),b(y,[2,37]),b(w,[2,30]),{10:15,11:c,12:d,30:57,33:12,34:m,35:n,36:o,37:p,38:q,39:r,40:s,41:55,44:[1,56]},b(h,[2,2]),b(h,[2,11]),b(l,[2,16]),b(l,[2,17]),b(l,[2,45],{47:[1,58]}),b(l,[2,47]),{24:[1,59]},b(u,[2,21]),b(u,[2,22]),b(u,[2,23]),b(l,[2,40],{10:15,33:28,11:c,12:d}),b(v,[2,41]),b(v,[2,42]),b(l,[2,46]),{10:60,11:c,12:d},b(u,[2,20])],defaultActions:{},parseError:function(a,b){if(!b.recoverable){var c=new Error(a);throw c.hash=b,c}this.trace(a)},parse:function(a){var b=this,c=[0],d=[null],e=[],f=this.table,g="",h=0,i=0,j=0,k=2,l=1,m=e.slice.call(arguments,1),n=Object.create(this.lexer),o={yy:{}};for(var p in this.yy)Object.prototype.hasOwnProperty.call(this.yy,p)&&(o.yy[p]=this.yy[p]);n.setInput(a,o.yy),o.yy.lexer=n,o.yy.parser=this,"undefined"==typeof n.yylloc&&(n.yylloc={});var q=n.yylloc;e.push(q);var r=n.options&&n.options.ranges;"function"==typeof o.yy.parseError?this.parseError=o.yy.parseError:this.parseError=Object.getPrototypeOf(this).parseError;for(var s,t,u,v,w,x,y,z,A,B=function(){var a;return a=n.lex()||l,"number"!=typeof a&&(a=b.symbols_[a]||a),a},C={};;){if(u=c[c.length-1],this.defaultActions[u]?v=this.defaultActions[u]:(null!==s&&"undefined"!=typeof s||(s=B()),v=f[u]&&f[u][s]),"undefined"==typeof v||!v.length||!v[0]){var D="";A=[];for(x in f[u])this.terminals_[x]&&x>k&&A.push("'"+this.terminals_[x]+"'");D=n.showPosition?"Parse error on line "+(h+1)+":\n"+n.showPosition()+"\nExpecting "+A.join(", ")+", got '"+(this.terminals_[s]||s)+"'":"Parse error on line "+(h+1)+": Unexpected "+(s==l?"end of input":"'"+(this.terminals_[s]||s)+"'"),this.parseError(D,{text:n.match,token:this.terminals_[s]||s,line:n.yylineno,loc:q,expected:A})}if(v[0]instanceof Array&&v.length>1)throw new Error("Parse Error: multiple actions possible at state: "+u+", token: "+s);switch(v[0]){case 1:c.push(s),d.push(n.yytext),e.push(n.yylloc),c.push(v[1]),s=null,t?(s=t,t=null):(i=n.yyleng,g=n.yytext,h=n.yylineno,q=n.yylloc,j>0&&j--);break;case 2:if(y=this.productions_[v[1]][1],C.$=d[d.length-y],C._$={first_line:e[e.length-(y||1)].first_line,last_line:e[e.length-1].last_line,first_column:e[e.length-(y||1)].first_column,last_column:e[e.length-1].last_column},r&&(C._$.range=[e[e.length-(y||1)].range[0],e[e.length-1].range[1]]),w=this.performAction.apply(C,[g,i,h,o.yy,v[1],d,e].concat(m)),"undefined"!=typeof w)return w;y&&(c=c.slice(0,-1*y*2),d=d.slice(0,-1*y),e=e.slice(0,-1*y)),c.push(this.productions_[v[1]][0]),d.push(C.$),e.push(C._$),z=f[c[c.length-2]][c[c.length-1]],c.push(z);break;case 3:return!0}}return!0}},A=function(){var a={EOF:1,parseError:function(a,b){if(!this.yy.parser)throw new Error(a);this.yy.parser.parseError(a,b)},setInput:function(a,b){return this.yy=b||this.yy||{},this._input=a,this._more=this._backtrack=this.done=!1,this.yylineno=this.yyleng=0,this.yytext=this.matched=this.match="",this.conditionStack=["INITIAL"],this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0},this.options.ranges&&(this.yylloc.range=[0,0]),this.offset=0,this},input:function(){var a=this._input[0];this.yytext+=a,this.yyleng++,this.offset++,this.match+=a,this.matched+=a;var b=a.match(/(?:\r\n?|\n).*/g);return b?(this.yylineno++,this.yylloc.last_line++):this.yylloc.last_column++,this.options.ranges&&this.yylloc.range[1]++,this._input=this._input.slice(1),a},unput:function(a){var b=a.length,c=a.split(/(?:\r\n?|\n)/g);this._input=a+this._input,this.yytext=this.yytext.substr(0,this.yytext.length-b),this.offset-=b;var d=this.match.split(/(?:\r\n?|\n)/g);this.match=this.match.substr(0,this.match.length-1),this.matched=this.matched.substr(0,this.matched.length-1),c.length-1&&(this.yylineno-=c.length-1);var e=this.yylloc.range;return this.yylloc={first_line:this.yylloc.first_line,last_line:this.yylineno+1,first_column:this.yylloc.first_column,last_column:c?(c.length===d.length?this.yylloc.first_column:0)+d[d.length-c.length].length-c[0].length:this.yylloc.first_column-b},this.options.ranges&&(this.yylloc.range=[e[0],e[0]+this.yyleng-b]),this.yyleng=this.yytext.length,this},more:function(){return this._more=!0,this},reject:function(){return this.options.backtrack_lexer?(this._backtrack=!0,this):this.parseError("Lexical error on line "+(this.yylineno+1)+". You can only invoke reject() in the lexer when the lexer is of the backtracking persuasion (options.backtrack_lexer = true).\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},less:function(a){this.unput(this.match.slice(a))},pastInput:function(){var a=this.matched.substr(0,this.matched.length-this.match.length);return(a.length>20?"...":"")+a.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var a=this.match;return a.length<20&&(a+=this._input.substr(0,20-a.length)),(a.substr(0,20)+(a.length>20?"...":"")).replace(/\n/g,"")},showPosition:function(){var a=this.pastInput(),b=new Array(a.length+1).join("-");return a+this.upcomingInput()+"\n"+b+"^"},test_match:function(a,b){var c,d,e;if(this.options.backtrack_lexer&&(e={yylineno:this.yylineno,yylloc:{first_line:this.yylloc.first_line,last_line:this.last_line,first_column:this.yylloc.first_column,last_column:this.yylloc.last_column},yytext:this.yytext,match:this.match,matches:this.matches,matched:this.matched,yyleng:this.yyleng,offset:this.offset,_more:this._more,_input:this._input,yy:this.yy,conditionStack:this.conditionStack.slice(0),done:this.done},this.options.ranges&&(e.yylloc.range=this.yylloc.range.slice(0))),d=a[0].match(/(?:\r\n?|\n).*/g),d&&(this.yylineno+=d.length),this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:d?d[d.length-1].length-d[d.length-1].match(/\r?\n?/)[0].length:this.yylloc.last_column+a[0].length},this.yytext+=a[0],this.match+=a[0],this.matches=a,this.yyleng=this.yytext.length,this.options.ranges&&(this.yylloc.range=[this.offset,this.offset+=this.yyleng]),this._more=!1,this._backtrack=!1,this._input=this._input.slice(a[0].length),this.matched+=a[0],c=this.performAction.call(this,this.yy,this,b,this.conditionStack[this.conditionStack.length-1]),this.done&&this._input&&(this.done=!1),c)return c;if(this._backtrack){for(var f in e)this[f]=e[f];return!1}return!1},next:function(){if(this.done)return this.EOF;this._input||(this.done=!0);var a,b,c,d;this._more||(this.yytext="",this.match="");for(var e=this._currentRules(),f=0;f<e.length;f++)if(c=this._input.match(this.rules[e[f]]),c&&(!b||c[0].length>b[0].length)){if(b=c,d=f,this.options.backtrack_lexer){if(a=this.test_match(c,e[f]),a!==!1)return a;if(this._backtrack){b=!1;continue}return!1}if(!this.options.flex)break}return b?(a=this.test_match(b,e[d]),a!==!1&&a):""===this._input?this.EOF:this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){var a=this.next();return a?a:this.lex()},begin:function(a){this.conditionStack.push(a)},popState:function(){var a=this.conditionStack.length-1;return a>0?this.conditionStack.pop():this.conditionStack[0]},_currentRules:function(){return this.conditionStack.length&&this.conditionStack[this.conditionStack.length-1]?this.conditions[this.conditionStack[this.conditionStack.length-1]].rules:this.conditions.INITIAL.rules},topState:function(a){return a=this.conditionStack.length-1-Math.abs(a||0),a>=0?this.conditionStack[a]:"INITIAL"},pushState:function(a){this.begin(a)},stateStackSize:function(){return this.conditionStack.length},options:{},performAction:function(a,b,c,d){switch(c){case 0:return b.yytext;case 1:return this.begin("NOTE"),11;case 2:return this.begin("INITIAL"),15;case 3:return this.begin("CTRL"),21;case 4:return this.begin("INITIAL"),15;case 5:return this.begin("INITIAL"),16;case 6:return this.begin("CTRL"),20;case 7:return this.begin("CHORD"),42;case 8:return 26;case 9:return this.begin("NOTE"),14;case 10:break;case 11:break;case 12:return b.yytext[0];case 13:return 29;case 14:return 27;case 15:return 11;case 16:return 28;case 17:return 44;case 18:return 11;case 19:return 12;case 20:return this.begin("NOTE_DUR"),46;case 21:return 38;case 22:return 35;case 23:return 40;case 24:return 39;case 25:return b.yytext;case 26:return 4;case 27:console.log("Unrecognized token: ",b.yytext)}},rules:[/^(?:((melody|harmony|percussion)))/,/^(?:(([0-9])))/,/^(?:((\r|\n|\r\n)))/,/^(?:\|:)/,/^(?:\|)/,/^(?::\|)/,/^(?::)/,/^(?:@)/,/^(?:(([A-GR][#b]{0,2})))/,/^(?:(([ |\t|\f|\v]))+)/,/^(?:\s+)/,/^(?:((%[^\r\n]*((\r|\n|\r\n)))))/,/^(?:((key_sig|time_sig|instrument|[k|t|i])))/,/^(?:((rate|volume|ctrls|[r|c|v])))/,/^(?:((out|scale|[o|s])))/,/^(?:(([0-9]))+)/,/^(?:\{[a-zA-Z_][a-zA-Z_0-9]*\})/,/^(?:[i])/,/^(?:(([0-9])))/,/^(?:\{(([0-9]))+\})/,/^(?:,)/,/^(?:[n])/,/^(?:[b])/,/^(?:~!)/,/^(?:~)/,/^(?:((,|;|\{|\}|\+|-|#|\/|\^)))/,/^(?:$)/,/^(?:.)/],conditions:{CTRL:{rules:[2,3,4,5,6,7,8,9,12,13,14,15,16,25,26,27],inclusive:!0},NOTE:{rules:[2,3,4,5,6,7,8,9,18,19,20,21,22,23,24,25,26,27],inclusive:!0},NOTE_DUR:{rules:[2,3,4,5,6,7,8,9,15,25,26,27],inclusive:!0},CHORD:{rules:[3,4,5,6,7,8,9,17,18,25,26,27],inclusive:!0},INITIAL:{rules:[0,1,3,4,5,6,7,8,10,11,19,25,26,27],inclusive:!0}}};return a}();return z.lexer=A,a.prototype=z,z.Parser=a,new a}();"undefined"!=typeof require&&"undefined"!=typeof exports&&(exports.parser=score_parser,exports.Parser=score_parser.Parser,exports.parse=function(){return score_parser.parse.apply(score_parser,arguments)},exports.main=function(a){a[1]||(console.log("Usage: "+a[0]+" FILE"),process.exit(1));var b=require("fs").readFileSync(require("path").normalize(a[1]),"utf8");return exports.parser.parse(b)},"undefined"!=typeof module&&require.main===module&&exports.main(process.argv.slice(1)));var schema_parser=function(){function a(){this.yy={}}var b=function(a,b,c,d){for(c=c||{},d=a.length;d--;c[a[d]]=b);return c},c=[2,3],d=[1,2],e=[1,4],f=[1,4,6,15],g=[1,8],h=[1,10],i=[1,12],j=[6,8],k=[1,29],l=[1,32],m=[13,15],n=[1,39],o=[1,41],p=[1,43],q=[1,44],r=[1,40],s=[1,42],t=[13,15,29],u=[13,29],v={trace:function(){},yy:{},symbols_:{error:2,e:3,EOF:4,RULE:5,IDENT:6,R:7,";":8,"--":9,NUMBER:10,"=":11,"{":12,",":13,OPTIONS:14,"}":15,"->":16,NODES:17,ACTION:18,OPTION:19,":":20,VAR:21,DIGITS:22,BOOL:23,"true":24,"false":25,STRING:26,"[":27,LIST:28,"]":29,$accept:0,$end:1},terminals_:{2:"error",4:"EOF",6:"IDENT",8:";",9:"--",11:"=",12:"{",13:",",15:"}",16:"->",20:":",22:"DIGITS",24:"true",25:"false",26:"STRING",27:"[",29:"]"},productions_:[0,[3,2],[3,2],[3,0],[5,3],[5,5],[5,8],[7,2],[7,5],[7,2],[17,3],[17,0],[18,3],[19,3],[14,1],[14,3],[10,1],[23,1],[23,1],[21,1],[21,1],[21,1],[21,1],[21,2],[21,3],[21,3],[28,0],[28,1],[28,3]],performAction:function(a,b,c,d,e,f,g){var h=f.length-1;switch(e){case 1:return this.$=f[h-1],this.$;case 2:f[h].length>2?(null!=f[h-1][f[h][0]]&&(f[h-1][f[h][0]]=[1,f[h-1][f[h][0]]]),f[h-1][f[h][0]].push([f[h][1],f[h][2]])):f[h-1][f[h][0]]=f[h][1],this.$=f[h-1];break;case 3:this.$={};break;case 4:this.$=[f[h-2],f[h-1]];break;case 5:this.$=[f[h-4],f[h-2],f[h-1]];break;case 6:this.$=[f[h-7],{mode:f[h-4]}],Object.assign(this.$[1],f[h-2]);break;case 7:this.$={structure:[],node:f[h],action:{}};break;case 8:null!=f[h-1]&&(f[h-4].action["_"+f[h-4].structure.length+"_"+f[h-3]]=f[h-1]),f[h-4].structure.push(f[h-3]);break;case 9:f[h-1].structure.push(f[h]);break;case 10:this.$=f[h-1];break;case 11:this.$={};break;case 12:this.$={},this.$.mode=f[h-2],Object.assign(this.$,f[h]);break;case 13:this.$=[f[h-2],f[h]];break;case 14:this.$={},this.$[f[h][0]]=f[h][1];break;case 15:f[h-2][f[h][0]]=f[h][1],this.$=f[h-2];break;case 16:this.$=parseFloat(f[h]);break;case 17:this.$=!0;break;case 18:this.$=!1;break;case 19:case 20:case 21:this.$=f[h];break;case 22:this.$=f[h].substr(1,f[h].length-2);break;case 23:this.$={};break;case 24:case 25:this.$=f[h-1];break;case 26:this.$=[];break;case 27:this.$=[f[h]];break;case 28:f[h-2].push(f[h]),this.$=f[h-2]}},table:[b([1,4,6],c,{3:1}),{1:[3],4:d,5:3,6:e},b(f,[2,1]),b(f,[2,2]),{7:5,9:[1,6],11:[1,7],16:g},{6:h,8:[1,9]},{10:11,22:i},{12:[1,13]},b(j,[2,11],{17:14,12:[1,15]}),b(f,[2,4]),b(j,[2,9],{12:[1,16]}),{7:17,16:g},b([13,15,16,29],[2,16]),{6:[1,18]},b(j,[2,7]),b([4,6,15],c,{3:19}),{6:[1,21],18:20},{6:h,8:[1,22]},{13:[1,23]},{4:d,5:3,6:e,15:[1,24]},{15:[1,25]},{13:[1,26]},b(f,[2,5]),{6:k,14:27,19:28},b(j,[2,10]),b(j,[2,8]),{6:k,14:30,19:28},{13:l,15:[1,31]},b(m,[2,14]),{20:[1,33]},{13:l,15:[2,12]},{8:[1,34]},{6:k,19:35},{6:n,10:38,12:o,21:36,22:i,23:37,24:p,25:q,26:r,27:s},b(f,[2,6]),b(m,[2,15]),b(m,[2,13]),b(t,[2,19]),b(t,[2,20]),b(t,[2,21]),b(t,[2,22]),{6:k,14:46,15:[1,45],19:28},b(u,[2,26],{23:37,10:38,28:47,21:48,6:n,12:o,22:i,24:p,25:q,26:r,27:s}),b(t,[2,17]),b(t,[2,18]),b(t,[2,23]),{13:l,15:[1,49]},{13:[1,51],29:[1,50]},b(u,[2,27]),b(t,[2,25]),b(t,[2,24]),{6:n,10:38,12:o,21:52,22:i,23:37,24:p,25:q,26:r,27:s},b(u,[2,28])],defaultActions:{},parseError:function(a,b){if(!b.recoverable){var c=new Error(a);throw c.hash=b,c}this.trace(a)},parse:function(a){var b=this,c=[0],d=[null],e=[],f=this.table,g="",h=0,i=0,j=0,k=2,l=1,m=e.slice.call(arguments,1),n=Object.create(this.lexer),o={yy:{}};for(var p in this.yy)Object.prototype.hasOwnProperty.call(this.yy,p)&&(o.yy[p]=this.yy[p]);n.setInput(a,o.yy),o.yy.lexer=n,o.yy.parser=this,"undefined"==typeof n.yylloc&&(n.yylloc={});var q=n.yylloc;e.push(q);var r=n.options&&n.options.ranges;"function"==typeof o.yy.parseError?this.parseError=o.yy.parseError:this.parseError=Object.getPrototypeOf(this).parseError;for(var s,t,u,v,w,x,y,z,A,B=function(){var a;return a=n.lex()||l,"number"!=typeof a&&(a=b.symbols_[a]||a),a},C={};;){if(u=c[c.length-1],this.defaultActions[u]?v=this.defaultActions[u]:(null!==s&&"undefined"!=typeof s||(s=B()),v=f[u]&&f[u][s]),"undefined"==typeof v||!v.length||!v[0]){var D="";A=[];for(x in f[u])this.terminals_[x]&&x>k&&A.push("'"+this.terminals_[x]+"'");D=n.showPosition?"Parse error on line "+(h+1)+":\n"+n.showPosition()+"\nExpecting "+A.join(", ")+", got '"+(this.terminals_[s]||s)+"'":"Parse error on line "+(h+1)+": Unexpected "+(s==l?"end of input":"'"+(this.terminals_[s]||s)+"'"),this.parseError(D,{text:n.match,token:this.terminals_[s]||s,line:n.yylineno,loc:q,expected:A})}if(v[0]instanceof Array&&v.length>1)throw new Error("Parse Error: multiple actions possible at state: "+u+", token: "+s);switch(v[0]){case 1:c.push(s),d.push(n.yytext),e.push(n.yylloc),c.push(v[1]),s=null,t?(s=t,t=null):(i=n.yyleng,g=n.yytext,h=n.yylineno,q=n.yylloc,j>0&&j--);break;case 2:if(y=this.productions_[v[1]][1],C.$=d[d.length-y],C._$={first_line:e[e.length-(y||1)].first_line,last_line:e[e.length-1].last_line,first_column:e[e.length-(y||1)].first_column,last_column:e[e.length-1].last_column},r&&(C._$.range=[e[e.length-(y||1)].range[0],e[e.length-1].range[1]]),w=this.performAction.apply(C,[g,i,h,o.yy,v[1],d,e].concat(m)),"undefined"!=typeof w)return w;y&&(c=c.slice(0,-1*y*2),d=d.slice(0,-1*y),e=e.slice(0,-1*y)),c.push(this.productions_[v[1]][0]),d.push(C.$),e.push(C._$),z=f[c[c.length-2]][c[c.length-1]],c.push(z);break;case 3:return!0}}return!0}},w=function(){var a={EOF:1,parseError:function(a,b){if(!this.yy.parser)throw new Error(a);this.yy.parser.parseError(a,b)},setInput:function(a,b){return this.yy=b||this.yy||{},this._input=a,this._more=this._backtrack=this.done=!1,this.yylineno=this.yyleng=0,this.yytext=this.matched=this.match="",this.conditionStack=["INITIAL"],this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0},this.options.ranges&&(this.yylloc.range=[0,0]),this.offset=0,this},input:function(){var a=this._input[0];this.yytext+=a,this.yyleng++,this.offset++,this.match+=a,this.matched+=a;var b=a.match(/(?:\r\n?|\n).*/g);return b?(this.yylineno++,this.yylloc.last_line++):this.yylloc.last_column++,this.options.ranges&&this.yylloc.range[1]++,this._input=this._input.slice(1),a},unput:function(a){var b=a.length,c=a.split(/(?:\r\n?|\n)/g);this._input=a+this._input,this.yytext=this.yytext.substr(0,this.yytext.length-b),this.offset-=b;var d=this.match.split(/(?:\r\n?|\n)/g);this.match=this.match.substr(0,this.match.length-1),this.matched=this.matched.substr(0,this.matched.length-1),c.length-1&&(this.yylineno-=c.length-1);var e=this.yylloc.range;return this.yylloc={first_line:this.yylloc.first_line,last_line:this.yylineno+1,first_column:this.yylloc.first_column,last_column:c?(c.length===d.length?this.yylloc.first_column:0)+d[d.length-c.length].length-c[0].length:this.yylloc.first_column-b},this.options.ranges&&(this.yylloc.range=[e[0],e[0]+this.yyleng-b]),this.yyleng=this.yytext.length,this},more:function(){return this._more=!0,this},reject:function(){return this.options.backtrack_lexer?(this._backtrack=!0,this):this.parseError("Lexical error on line "+(this.yylineno+1)+". You can only invoke reject() in the lexer when the lexer is of the backtracking persuasion (options.backtrack_lexer = true).\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},less:function(a){this.unput(this.match.slice(a))},pastInput:function(){var a=this.matched.substr(0,this.matched.length-this.match.length);return(a.length>20?"...":"")+a.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var a=this.match;return a.length<20&&(a+=this._input.substr(0,20-a.length)),(a.substr(0,20)+(a.length>20?"...":"")).replace(/\n/g,"")},showPosition:function(){var a=this.pastInput(),b=new Array(a.length+1).join("-");return a+this.upcomingInput()+"\n"+b+"^"},test_match:function(a,b){var c,d,e;if(this.options.backtrack_lexer&&(e={yylineno:this.yylineno,yylloc:{first_line:this.yylloc.first_line,last_line:this.last_line,first_column:this.yylloc.first_column,last_column:this.yylloc.last_column},yytext:this.yytext,match:this.match,matches:this.matches,matched:this.matched,yyleng:this.yyleng,offset:this.offset,_more:this._more,_input:this._input,yy:this.yy,conditionStack:this.conditionStack.slice(0),done:this.done},this.options.ranges&&(e.yylloc.range=this.yylloc.range.slice(0))),d=a[0].match(/(?:\r\n?|\n).*/g),d&&(this.yylineno+=d.length),this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:d?d[d.length-1].length-d[d.length-1].match(/\r?\n?/)[0].length:this.yylloc.last_column+a[0].length},this.yytext+=a[0],this.match+=a[0],this.matches=a,this.yyleng=this.yytext.length,this.options.ranges&&(this.yylloc.range=[this.offset,this.offset+=this.yyleng]),this._more=!1,this._backtrack=!1,this._input=this._input.slice(a[0].length),this.matched+=a[0],c=this.performAction.call(this,this.yy,this,b,this.conditionStack[this.conditionStack.length-1]),this.done&&this._input&&(this.done=!1),c)return c;if(this._backtrack){for(var f in e)this[f]=e[f];return!1}return!1},next:function(){if(this.done)return this.EOF;this._input||(this.done=!0);var a,b,c,d;this._more||(this.yytext="",this.match="");for(var e=this._currentRules(),f=0;f<e.length;f++)if(c=this._input.match(this.rules[e[f]]),c&&(!b||c[0].length>b[0].length)){if(b=c,d=f,this.options.backtrack_lexer){if(a=this.test_match(c,e[f]),a!==!1)return a;if(this._backtrack){b=!1;continue}return!1}if(!this.options.flex)break}return b?(a=this.test_match(b,e[d]),a!==!1&&a):""===this._input?this.EOF:this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){var a=this.next();return a?a:this.lex()},begin:function(a){this.conditionStack.push(a)},popState:function(){var a=this.conditionStack.length-1;return a>0?this.conditionStack.pop():this.conditionStack[0]},_currentRules:function(){return this.conditionStack.length&&this.conditionStack[this.conditionStack.length-1]?this.conditions[this.conditionStack[this.conditionStack.length-1]].rules:this.conditions.INITIAL.rules},topState:function(a){return a=this.conditionStack.length-1-Math.abs(a||0),a>=0?this.conditionStack[a]:"INITIAL"},pushState:function(a){this.begin(a)},stateStackSize:function(){return this.conditionStack.length},options:{},performAction:function(a,b,c,d){switch(c){case 0:break;case 1:break;case 2:return 26;case 3:return b.yytext;case 4:return b.yytext;case 5:return 22;case 6:return 6;case 7:return 4;case 8:console.log("unrecognized token: ",b.yytext)}},rules:[/^(?:\s+)/,/^(?:((%[^\r\n]*((\r|\n|\r\n)))))/,/^(?:(("[^\"]+")))/,/^(?:((;|\{|\}|\[|\]|:|,|=|->|\(|\)|<|>|--)))/,/^(?:((true|false)))/,/^(?:(([+-]?[\d.]+)))/,/^(?:(([a-zA-z]\w*)))/,/^(?:$)/,/^(?:.)/],conditions:{INITIAL:{rules:[0,1,2,3,4,5,6,7,8],inclusive:!0}}};return a}();return v.lexer=w,a.prototype=v,v.Parser=a,new a}();"undefined"!=typeof require&&"undefined"!=typeof exports&&(exports.parser=schema_parser,exports.Parser=schema_parser.Parser,exports.parse=function(){return schema_parser.parse.apply(schema_parser,arguments)},exports.main=function(a){a[1]||(console.log("Usage: "+a[0]+" FILE"),process.exit(1));var b=require("fs").readFileSync(require("path").normalize(a[1]),"utf8");return exports.parser.parse(b)},"undefined"!=typeof module&&require.main===module&&exports.main(process.argv.slice(1))),function(){var a,b,c,d,e,f,g,h,i,j,k=function(a,b){return(+a%(b=+b)+b)%b},l=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};a=null!=(i=this.MG)?i:{},a.instrs={Piano:["1 Acoustic Grand Piano","2 Bright Acoustic Piano","3 Electric Grand Piano","4 Honky-tonk Piano","5 Electric Piano 1","6 Electric Piano 2","7 Harpsichord","8 Clavinet"],"Chromatic Percussion":["9 Celesta","10 Glockenspiel","11 Music Box","12 Vibraphone","13 Marimba","14 Xylophone","15 Tubular Bells","16 Dulcimer"],Organ:["17 Drawbar Organ","18 Percussive Organ","19 Rock Organ","20 Church Organ","21 Reed Organ","22 Accordion","23 Harmonica","24 Tango Accordion"],Guitar:["25 Acoustic Guitar (nylon)","26 Acoustic Guitar (steel)","27 Electric Guitar (jazz)","28 Electric Guitar (clean)","29 Electric Guitar (muted)","30 Overdriven Guitar","31 Distortion Guitar","32 Guitar Harmonics"],Bass:["33 Acoustic Bass","34 Electric Bass (finger)","35 Electric Bass (pick)","36 Fretless Bass","37 Slap Bass 1","38 Slap Bass 2","39 Synth Bass 1","40 Synth Bass 2"],Strings:["41 Violin","42 Viola","43 Cello","44 Contrabass","45 Tremolo Strings","46 Pizzicato Strings","47 Orchestral Harp","48 Timpani"],Ensemble:["49 String Ensemble 1","50 String Ensemble 2","51 Synth Strings 1","52 Synth Strings 2","53 Choir Aahs","54 Voice Oohs","55 Synth Choir","56 Orchestra Hit"],Brass:["57 Trumpet","58 Trombone","59 Tuba","60 Muted Trumpet","61 French Horn","62 Brass Section","63 Synth Brass 1","64 Synth Brass 2"],Reed:["65 Soprano Sax","66 Alto Sax","67 Tenor Sax","68 Baritone Sax","69 Oboe","70 English Horn","71 Bassoon","72 Clarinet"],Pipe:["73 Piccolo","74 Flute","75 Recorder","76 Pan Flute","77 Blown Bottle","78 Shakuhachi","79 Whistle","80 Ocarina"],"Synth Lead":["81 Lead 1 (square)","82 Lead 2 (sawtooth)","83 Lead 3 (calliope)","84 Lead 4 (chiff)","85 Lead 5 (charang)","86 Lead 6 (voice)","87 Lead 7 (fifths)","88 Lead 8 (bass + lead)"],"Synth Pad":["89 Pad 1 (new age)","90 Pad 2 (warm)","91 Pad 3 (polysynth)","92 Pad 4 (choir)","93 Pad 5 (bowed)","94 Pad 6 (metallic)","95 Pad 7 (halo)","96 Pad 8 (sweep)"],"Synth Effects":["97 FX 1 (rain)","98 FX 2 (soundtrack)","99 FX 3 (crystal)","100 FX 4 (atmosphere)","101 FX 5 (brightness)","102 FX 6 (goblins)","103 FX 7 (echoes)","104 FX 8 (sci-fi)"],Ethnic:["105 Sitar","106 Banjo","107 Shamisen","108 Koto","109 Kalimba","110 Bagpipe","111 Fiddle","112 Shanai"],Percussive:["113 Tinkle Bell","114 Agogo","115 Steel Drums","116 Woodblock","117 Taiko Drum","118 Melodic Tom","119 Synth Drum"],"Sound effects":["120 Reverse Cymbal","121 Guitar Fret Noise","122 Breath Noise","123 Seashore","124 Bird Tweet","125 Telephone Ring","126 Helicopter","127 Applause","128 Gunshot"]},a.percussion={27:"High-Q",28:"Slap",29:"Scratch Push",30:"Scratch Pull",31:"Sticks",32:"Square Click",33:"Metronome Click",34:"Metronome Bell",35:"Acoustic Bass Drum",36:"Bass Drum",37:"Side Stick",38:"Acoustic Snare",39:"Hand Clap",40:"Electric Snare",41:"Low Floor Tom",42:"Closed Hi Hat",43:"High Floor Tom",44:"Pedal Hi-Hat",45:"Low Tom",46:"Open Hi-Hat",47:"Low-Mid Tom",48:"Hi-Mid Tom",49:"Crash Cymbal 1",50:"High Tom",51:"Ride Cymbal 1",52:"Chinese Cymbal",53:"Ride Bell",54:"Tambourine",55:"Splash Cymbal",56:"Cowbell",57:"Crash Cymbal 2",58:"Vibraslap",59:"Ride Cymbal 2",60:"Hi Bongo",61:"Low Bongo",62:"Mute Hi Conga",63:"Open Hi Conga",64:"Low Conga",65:"High Timbale",66:"Low Timbale",67:"High Agogo",68:"Low Agogo",69:"Cabasa",70:"Maracas",71:"Short Whistle",72:"Long Whistle",73:"Short Guiro",74:"Long Guiro",75:"Claves",76:"Hi Wood Block",77:"Low Wood Block",78:"Mute Cuica",79:"Open Cuica",
80:"Mute Triangle",81:"Open Triangle",82:"Shaker",83:"Jingle Bell",84:"Bell Tree",85:"Castanets",86:"Mute Surdo",87:"Open Surdo"},a.arpeg={123:["123","13","123 123","13 13","1 23","1,2 23","1 23 23","1 2 3","1 3 2","1 3 2 3","1 2 3 2","1 2 3 2 3 2"],"1231+":["1234","134","1 234","1 2 3 4","1 3 4 3","1 2 3 4 3 2"],"132+":["1 2 3 2 3 2 3 2"],"1-131+":["12 3 4 3","12,2 2 3 4,2 3,2"]},a.texture=void 0,a.chord_class={maj:[0,4,7],min:[0,3,7],dim:[0,3,6],aug:[0,4,8],sus2:[0,2,7],sus4:[0,5,7],dom7:[0,4,7,10],dom7b5:[0,4,6,10],min7:[0,3,7,10],min7b5:[0,3,6,10],aug7:[0,4,8,10],maj7:[0,4,7,11],maj7b5:[0,4,6,11],"min7#":[0,3,7,11],"aug7#":[0,4,8,11],dim7:[0,3,6,9],add9:[0,2,4,7],minadd11:[0,3,5,7],add11:[0,4,5,7]},a.chord_class_label={maj:"Major triad",min:"Minor triad",aug:"Augmented triad",dim:"Diminished triad",dom7:"Dominant seventh chord",maj7:"Major seventh chord",min7:"Minor seventh chord",aug7:"Augmented seventh chord",dim7:"Diminished seventh chord",min7b5:"Half diminished chord","min7#":"Minor seventh shart fifth chord",sus2:"Suspended second chord",sus4:"Suspended fourth chord",add9:"Add ninth chord",add11:"Add eleventh chord"},a.inverted=function(a,b){var c,d,e,f;for(null==b&&(b=1),b=k(b,a.length),f=new Array(a.length),c=d=0,e=a.length;d<e;c=d+=1)f[c]=k(a[(b+c)%a.length]-a[b],12);return f},a.chords=function(){var b,c,d,e,f,g,h,i;h={},f=a.chord_class;for(b in f)for(i=f[b],c=b+"",d=e=0,g=i.length;e<g;d=e+=1)h[c]=a.inverted(i,d),c+="i";return h}(),a.chord_finder=function(){var b,c,d,e;d={},c=a.chords;for(b in c)e=c[b],e.toString()in d||(d[e.toString()]=b);return d[[0,5,7].toString()]="sus4",d}(),a.interval_class={u1:0,m2:1,M2:2,m3:3,M3:4,p4:5,a4:6,d5:6,p5:7,m6:8,M6:9,m7:10,M7:11,o8:12},a.consonant_interval=["u1","p4","p5","m6","M6","o8",0,3,4,5,7,8,9],a.dissonant_interval=["m2","M2","a4","d5","m7","M7",1,2,6,10,11],a.key_class=function(){var a,b,c;return a=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"],b=["B#","C#","D","D#","Fb","E#","F#","G","G#","A","A#","Cb"],c={},a.forEach(function(a,b){c[a]=b}),b.forEach(function(a,b){c[a]=b}),c}(),a.scale_class={maj:[0,2,4,5,7,9,11],min:[0,2,3,5,7,8,10],min_harmonic:[0,2,3,5,7,8,11],maj_harmonic:[0,2,4,5,8,9,11],min_melodic:[0,2,3,5,7,9,11],chromatic:[0,1,2,3,4,5,6,7,8,9,10,11],octatonic:[0,1,3,4,6,7,9,10],whole:[0,2,4,6,8,10],dorian:[0,2,3,5,7,9,10],lydian:[0,2,4,6,7,9,11],pent:[0,2,4,7,9],pent_min:[0,3,5,7,10],zhi:[0,2,5,7,9],blues:[0,3,5,6,7,10]},this.white_key_num=a.scale_class.maj,this.black_key_num=[1,3,6,8,10],a.scaleToPitch=function(b,c){var d,e,f,g;return g=null!=(e=a.scale_class[b])?e:a.scale_class.maj,d=null!=(f=a.key_class[c])?f:0,function(a){return d+12*Math.floor(a/g.length)+g[k(a,g.length)]+12}},a.pitchToScale=function(b,c){var d,e,f,g;return g=null!=(e=a.scale_class[b])?e:a.scale_class.maj,d=null!=(f=a.key_class[c])?f:0,function(a){var b,c,e,f;for(a-=d,c=Math.floor(a/12)-1,a=k(a,12),b=e=f=g.length-1;e>=0;b=e+=-1)if(a>=g[b])return[b,c,a-g[b]];return[0,c,a-g[0]]}},a.testPitchScaleConversion=function(){var b,c,d,e,f,g,h,i,j,k,l;g=a.scale_class;for(h in g){e=g[h],b=!0;for(l in a.key_class)for(j=a.scaleToPitch(h,l),k=a.pitchToScale(h,l),c=f=21;f<=108;c=++f)i=k(c),d=j(i[0]+e.length*i[1])+i[2],d!==c&&(b=!1,console.log(l,h,c,i,d));b&&console.log(h,"success")}},a.keyToPitch=function(b){var c,d,e,f,g;return c=/[A-G][#b]{0,2}/.exec(b)[0],null==c&&(c="C"),e=null!=(f=a.key_class[c])?f:0,d=/[0-9]/.exec(b)[0],d=null!=(g=parseInt(d))?g:4,12+e+12*d},a.pitchToKey=function(a,b,c){var d,e;if(!(a<21||a>108))return d=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"],b===!0&&(d=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"]),e=a%12,null!=c?d[e]:[d[e],Math.floor(a/12)-1]},a.testPitchKeyConversion=function(){var b,c,d,e,f;for(b=!0,c=e=21;e<=108;c=++e)f=a.pitchToKey(c,!0),d=a.keyToPitch(f[0]+f[1]),d!==c&&(b=!1,console.log(c,f,d));b&&console.log("success")},a.transposer=function(b,c){var d,e,f;return null==b&&(b="chromatic"),console.log(b,"transposer"),null==c&&(c="C"),d=a.scale_class[b].length,f=a.pitchToScale(b,c),e=a.scaleToPitch(b,c),function(a,b){var c;return c=f(a),e(c[0]+c[1]*d+b)+c[2]}},c={7:"dom7","":"maj",M:"maj",m:"min",mi:"min",m7:"min7","m7#":"min7#",m7b5:"min7b5"},j=function(){var a,b;return a=["i","ii","iii","iv","v","vi","vii"],b={},a.forEach(function(a,c){return b[a.toUpperCase()]=b[a]=c}),b}(),a.getChords=function(b,d,e){var f,g,h,i,k,l,m,n,o;return h=/[A-G][b#]{0,2}/,i=/([VvIi]+)([b#]{0,2})/,null==e&&(e="C"),null==d&&(d=4),l=h.exec(b),n="C",k=0,null!==l?(n=l[0],k=l.index+l[0].length):(l=i.exec(b),null!==l&&(n=a.scale_keys[e][j[l[1]]]+(l[2]||""),n=n.replace(/b#/g,"").replace(/#b/g,""),k=l.index+l[0].length)),o=a.keyToPitch(n+d),f=b.substr(k),f=null!=(m=c[f])?m:f,g=a.chords[f]||a.chords.maj,[o,g]},a.keyToRoman=function(b){var c,d;return null==b&&(b="C"),c=["I","II","III","IV","V","VI","VII"],d=a.pitchToScale("maj",b),function(b){var e,f,g;return f=a.keyToPitch(b+"4"),g=d(f),e=c[g[0]],g[2]>0&&(e+="#"),e}},a.key_sig_rev={},a.key_sig=function(){var b,c,d,e,f,g;for(d=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"],g={},b=f=0;f<12;b=f+=1)c=7*b%12,e=(b+6)%12-6,g[d[c]]=e,a.key_sig_rev[e]=d[c];return g["F#"]=6,a.key_sig_rev[6]="F#",g}(),a.keyNames=function(){var b,c;return c=new Array(12).fill(0).map(function(a){return[]}),b=a.scale_class.maj,"CDEFGAB".split("").forEach(function(a,d){return c[k(b[d]-2,12)].push(a+"bb"),c[k(b[d]-1,12)].push(a+"b"),c[b[d]%12].push(a),c[(b[d]+1)%12].push(a+"#"),c[(b[d]+2)%12].push(a+"##")}),c}(),a.scale_keys=function(){var b,c,d;return b=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"],d={},d.C="CDEFGAB".split(""),c=a.scale_class.maj,b.forEach(function(b,e){var f,g,h,i,j,k,l,m;if("C"!==b){for(d[b]=[b],l=[],f=j=1,k=c.length;j<k;f=j+=1)i=(e+c[f])%12,h=a.keyNames[i],l.push(function(){var a;a=[];for(g in h){if(m=h[g],m[0]===d.C[(d.C.indexOf(b[0])+f)%7]){d[b].push(m);break}a.push(void 0)}return a}());return l}}),d}(),this.score_summer=a.score_summer={settings:{tempo:120,time_sig:[4,4],key_sig:"C",scale:"maj",ctrl_per_beat:16,volumes:[110,80],instrs:[66,1]},contents:{melody:":+ 0,2 3 1/3,1^/3,2 2 1 2 3 1,2/:- 6 3,1^/3,2 :+ 3 1/2 2,7^/2,2 1 6- 1 6- 1,2/:- 7,1^/7,4 0 :+ 3,2 1/3 3,2 3,1^ 3,4^/3,2 2 1 2 3 1,2/:- 6 3,1^/3,3 3/5,2 3 5 6,2 :+ 1,2/3 2,3 1,4/:- 6,1^/6,2 :+ 3 1".split("/"),harmony:"E7/Amin/Bb7/Amin E7/Amin A7/Dmin/F7/F#min7 B7/E7/Am/Bb7/Am/D7/C Am/D7 E7/Am D7/Bm7 E7".split("/"),texture:"@-123 0 123/@-11-32+ 12 3 4 3/@iii-11-32+ 12 3 4 3/@-123 123 @-123 123/@-123 123 @-123 123/@-11-32+ 12 3 4 3/@-11-32+ 12 3 4 3/@-123 123 123/@-11-32+ 12 3 4 3/@-123 123 123/@-123 123 123/@-123 123 123/@-123 123 123/@-123 123 @-123 123/@-123 123 @-123 123/@-123 123 @-123 123/@-123 123 @-123 123".split("/")}},a.gen_modes=["random","transpose","chord","reverse","diminuation","augmentation"],a.sample_seeds={s3:{mode:"distribution",dur:12,choices:[[4,4,4]],weights:[1]},s0:{mode:"distribution",dur:12,choices:[[4,4,4],[12]],weights:[5,2]},s1:{mode:"distribution",dur:16,choices:"4 4 4 4/8 4 4/4 4 8/4 8 4/4 12/12 4/8 8/16".split("/").map(function(a){return a.split(/\s+/).map(function(a){return parseInt(a)})}),weights:[1,3,3,5,1,5,8,8]},s2:{mode:"distribution",weights:[1,2,5,12,6,30,8,30,12,8,3,1,1],choices:function(){return Array(13).fill().map(function(a,b){return b-6})}()}},this.schema_summer=a.schema_summer={S:{structure:"c/A/B/Br/A/C/c".split("/"),node:{c:{mode:"random",dur:32,incomplete_start:32,chord_tone:4,scale_tone:[2,1,1,.5,2,1,.5],chords:["E7"],rhythm:{seed:"s1",swarp:.5},interval:{chromatic:!1,seed:"s2"}},A:{mode:"random",dur:256,chord_tone:4,chromatic_tone:.5,chords:["Amin","Bb7","Amin E7","Amin A7"],rhythm:{seed:"s1",swarp:.5},interval:{chromatic:!1,seed:"s2"},range:[56,77],dist:"linear"},B:{structure:["A"],action:{A:{mode:"transpose",dur:128,offset:0,scale:"maj",interval:3}}},Br:{structure:["B"],action:{B:{mode:"reverse",deep:!0}}},C:{mode:"random",dur:224,incomplete_end:32,chord_tone:4,chords:"C Am/D7 E7/Am D7/Bm7".split("/"),rhythm:{seed:"s1",swarp:.5},interval:{chromatic:!1,seed:"s2"},range:[56,77],dist:"quadratic"}}},s1:a.sample_seeds.s1,s2:a.sample_seeds.s2},a.schemaAdd=function(a,b,c,d){null!=c&&(a.node[b]=c),null!=d&&(a.action["_"+a.structure.length+"_"+b]=d),a.structure.push(b)},a.schemaBuilder=function(b){var c;return c={structure:[],node:{},action:{}},a.schemaAdd(c,"A",{mode:"random",dur:b,rhythm:{seed:"s1"},interval:{seed:"s2"}}),c},a.score_dance={settings:{tempo:188,time_sig:[6,8],key_sig:"C",scale:"maj",ctrl_per_beat:4,volumes:[110,80],instrs:[1,1]},contents:{harmony:["Am7#,3 Am,4","G#dim7 Am","Am7#,3 Am,2 E7,2","Am7b5 G#dim","Am","F","C7","C7","F F7","Fm Fm7#","C7","Fm","C7","F","C7","C7","F F7","Fm Fm7#","C7","Fm","C7","Fm C7","C7 F7","F7 ","Am7#,3 Am,4","G#dim7 Am","Am7#,3 Am,2 E7,2","Am7b5 G#dim","Am","Am",""]},melody:["%% A",":+t7/8 3 4 3 2# 3 7- 1 2 1 0 :- 6 0 3 0",":t6/8 7,4 3 0 :+ 1 2 1 0 3- 0",":t7/8 3 4 3 2# 3 7- 1 2 1 0 :- 6 0 3 0",":t6/8 6,4 6 0 7,4 5# 0","6 0 :+ 1 0 3 0 6,2 0,2 1 0","%% B","1,3 2 1,2 4,4 3,2","3,3 2,2 1","1,3 2 1,2 5,4 4,2","4,3 1,2 1",":kAb 1,2 1 1 :- 7 6","7,2 5# 3,2 3","6,2 7 1+ 7 6","2+,3 7,2 3+",":kC+ 1,3 2 1,2 4,4 3,2","3,3 2,2 1","1,3 2 1,2 5,4 4,2","4,3 1,2 1",":kAb 1,2 1 1 :- 7 6","7,2 5# 3,2 3","6,2 7 1+ 7 6","2+,4 7,2 :+ 3 0 4# 5 5# 7","1+,2 1+ 7 6 1+ 7 0 5# 0 3 0","7,2 7 6 5# 7 6 0 3 0 1# 0",":kC :+ 3b,4 3,2 4 3 2# 3 4 0","%% A",":t7/8 3 4 3 2# 3 7- 1 2 1 0 :- 6 0 3 0",":t6/8 7,4 3 0 :+ 1 2 1 0 3- 0",":t7/8 3 4 3 2# 3 7- 1 2 1 0 :- 6 0 3 0",":t6/8 6,4 6 0 7,4 5# 0","6 :+ 1 3 1 6 5# 6,2 0,4","136 0,2",""],texture:["%% A",":t7/8 @1-2341+ 1 235 234 @1-231+ 1 34 23 0",":t6/8 @1-234 1 234 0 @1234 1 234 0",":t7/8 @1-2341+ 1 235 234 @123 1 23 @341+ 123 0",":t6/8 @ii1234 14 23 0 @1231+ 14 23 0","@1231+ 1 3 2 234 0,2","%% B","% b1","@1231+ 1 23 34 1 34 23","@12341+ 1 245 23 1 245 23","@12341+ 2 345 345 1 345 345","@1231+ 1 34 23  @1234 1 3 24","@1233- 1 23 4  @124- 12 3 1","@12331+ 23 1 0 34 45 0","@1231- 1 23 4 1 23 4","@12341+2+ 1 235 46 2 35 1 ","% b2","@1231+ 1 23 34 1 34 23","@12341+ 1 245 23 1 245 23","@12341+ 2 345 345 1 345 345","@1231+ 1 34 23  @1234 1 3 24","@1233- 1 23 4  @124- 12 3 1","@12331+ 23 1 0 34 45 0","@1231- 1 23 4 1 23 4","@2341+2+ 1 245 0 134 0,2","% bridge","@1234 1 23 34 @i1234 1 24 23 ","1 234 234 @1234- 1 23 4","@12341+ 124 3 0 235 0,2","%% A",":t7/8 @1-2341+ 1 235 234 @1-231+ 1 34 23 0",":t6/8 @1-234 1 234 0 @1234 1 234 0",":t7/8 @1-2341+ 1 235 234 @123 1 23 @341+ 123 0",":t6/8 @ii1234 14 23 0 @1231+ 14 23 0","@1231+ 1 3 2 234 0,2","@13 13 0,2",""]},a.schema_dance="S",a.clone=function(){var a;return a=function(b){var c,d;if("object"!=typeof b||null===b)return b;d=Array.isArray(b)?[]:{};for(c in b)d[c]=a(b[c]);return d},function(b){return a(b)}}(),a.circularClone=function(a){var b,c,d;return d=[],c=function(a){var b;for(b=0;b<d.length;){if(d[b][0]===a)return d[b][1];++b}return null},(b=function(a){var e,f;if("object"!=typeof a||null===a)return a;if(f=c(a),null!==f)return f;f=Array.isArray(a)?[]:{},d.push([a,f]);for(e in a)f[e]=b(a[e]);return f})(a)},a.top_sort=function(a){var b,c,d,e,f;for(c=Object.keys(a).length,d=function(b){var c,d;for(c in a)for(d=a[c];l.call(d,b)>=0;)d.splice(d.indexOf(b),1);return delete a[b]},b=function(){var b,c;for(b in a)if(c=a[b],c.length<=0)return b;return null},e=[];e.length<c;){if(f=b(),null===f){console.log("circular dependency",a);break}e.push(f),d(f)}return e},f=function(a,b){for(var c;b>0;)c=b,b=a%b,a=c;return a},h=function(a,b){return a/f(a,b)*b},a.gcd=function(){var a,b,c,d;for(d=f(arguments[0],arguments[1]),a=b=2,c=arguments.length;b<c;a=b+=1)d=f(d,arguments[a]);return d},a.lcm=function(){var a,b,c,d;for(d=h(arguments[0],arguments[1]),a=b=2,c=arguments.length;b<c;a=b+=1)d=h(d,arguments[a]);return d},a.rndPicker=function(b,c){var d,e,f,g,h;for(1===arguments.length&&(c=_.values(arguments[0]),b=_.keys(arguments[0])),h=math.sum(c),e=c.map(function(a){return a/h}),h=0,d=f=0,g=e.length;f<g;d=f+=1)h=e[d]+=h;return{gen:function(){var c,f,g;for(c=a.seededRandom(),d=g=0,f=e.length;g<f;d=g+=1)if(c<e[d])return b[d];return b[e.length-1]}}},a.condCopy=function(a,b,c){var d,e,f;for(f=0,e=c.length;f<e;f++)d=c[f],null!=a[d]&&(b[d]=a[d])},a.obj_sort=function(a,b,c){var d;return null==b&&(b=!1),null==c&&(c=function(a){return a}),d=_.zip(_.keys(a),_.values(a)),b?d.sort(function(a,b){return c(b[1])-c(a[1])}):d.sort(function(a,b){return c(a[1])-c(b[1])}),d},b=6,a.seededRandom=function(a,c){var d;return a=a||1,c=c||0,b=(9301*b+49297)%233280,d=b/233280,c+d*(a-c)},d={I:[[0,"maj"],[5,"min"]],IV:[[3,"maj"],[1,"min"]],V:[[4,"maj"],[2,"min"],[6,"min7b5"]]},e=["I","IV","V","IV","V","I","V"],g={I:{I:1,IV:3,V:3},IV:{I:2,V:5,IV:1},V:{I:5,IV:3,V:1}},a.chord_hmm=function(b,c){var e,f,h,i;return null==c&&(c=g),h=["I"],f=a.scale_keys[b],i=function(){var b,e;return b=a.rndPicker(c[h.join(",")]),h[0]=b.gen(),e=d[h[0]],e[Math.floor(a.seededRandom()*e.length)]},e=function(a){var b,c,d,e,g;for(null==a&&(a=1),e=[],b=c=0,d=a;0<=d?c<d:c>d;b=0<=d?++c:--c)g=i(),g[0]=f[g[0]],e.push(g.join(""));return e},{start:function(a){return null==a&&(a="I"),"undefined"==typeof c[a]&&(a="I",console.log("invalid chord func",a)),h[0]=a,e()},gen:e}},a.parseHarmony=function(b,c){var d,e,f,g;return"undefined"==typeof b?void console.log("empty harmony"):(d=null!=(e=c.key_sigs[0])?e:"C",g=c.ctrl_per_beat*(null!=(f=c.time_sigs[0][0])?f:4),b.map(function(b,e){var f,h,i;return null!=c.time_sigs[e]&&(g=c.ctrl_per_beat*c.time_sigs[e][0]),null!=c.key_sigs[e]&&(d=c.key_sigs[e]),f=[],i=b.trim().split(/\s+/).map(function(b){var c,e,g;return g=b.split(","),c=a.getChords(g[0],3,d),e=g.length>=2?parseInt(g[1]):1,f.push(e),[e,c[0],c[1]]}),null!=g&&(h=Math.floor(g/math.sum(f)),f=[],i.forEach(function(a,b){return f.push(i[b][0]=Math.floor(a[0]*h))}),g>math.sum(f)&&(i[i.length-1][0]+=g-math.sum(f))),i}))},a.harmony_progresser=function(b){var c,d,e,f,g,h,i,j;return null==b&&(b=[]),i=0,c=-1,f=0,d=function(a){var d;return null==a&&(a=0),d=b[i][c],(d[1]+d[2][a])%12},h=function(){return c++,c>=b[i].length&&(c=0,i++,i>=b.length&&(i=b.length-1)),f-=b[i][c][0]},e=function(d){return null==d&&(d=0),a.inverted(b[i][c][2],d)},g=function(a){return f+=a},j=function(){var a;for(a=[];i<b.length&&f>=0;)a.push(h());return a},{bass:d,chord:e,process:j,forward:g}},a.score_parser=this.score_parser||"undefined"!=typeof module&&null!==module&&"undefined"!=typeof require&&null!==require&&require("../js/score_parser")||require("./js/score_parser"),a.schema_parser=this.schema_parser||"undefined"!=typeof module&&null!==module&&"undefined"!=typeof require&&null!==require&&require("../js/schema_parser")||require("./js/schema_parser"),a.schema_parser.produce=function(a){var b,c,d;return d=function(a,b){var c,e,f,g,h,i;if(null==b&&(b=""),g="",h=[],Array.isArray(a)){for(g+="[\n",b+="  ",f=0,e=a.length;f<e;f++)c=a[f],h.push(b+d(c,b));g+=h.join(",\n"),b=b.substr(2),g+="\n"+b+"]"}else if("object"==typeof a){g="{\n",b+="  ";for(c in a)i=a[c],"mode"===c?h.push(b+i.toString()):h.push(b+c+" : "+d(i,b));g+=h.join(",\n"),b=b.substr(2),g+="\n"+b+"}"}else g+="string"==typeof a?'"'+a+'"':a.toString();return g},c=function(a,b){var e,f,g;null==b&&(b=""),f="",b+="  ";for(e in a)g=a[e],null!=g.structure?(f+=b+e+" -> ",null!=g.node&&Object.keys(g.node).length>0&&(f+="{\n",f+=c(g.node,b),f+=b+"}"),f+="\n",g.structure.forEach(function(a,c){var e,h;return f+=b+a+" ",null!=g.action&&(h=null!=(e=g.action[a])?e:g.action["_"+c+"_"+a],null!=h&&(f+=d(h,b))),f+="\n"}),f+=b+";\n"):(f+=b+e+" = ",f+=d(g,b)+";\n");return b=b.substr(2),f},b="",c(a,b)},a.parseMelody=function(b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;try{j=a.score_parser.parse(b.join("\n")+"\n")}catch(f){return e=f,$.notify("parsing error!","warning"),void console.log(e.message)}switch(k=function(a,b,c){var d;if(d="number"==typeof a?a:a.original,d>c.length)console.log("exceed scale length"),d=c.length;else if(0===d)return 0;return d=b+c[d-1],"number"!=typeof a&&a.ornament.forEach(function(a){if("number"==typeof a)return d+=a}),d},j.mode){case"melody":p=c.scale,h=c.init_ref,g=c.harmony;break;case"harmony":g=c.harmony}return q=c.ctrl_per_beat*c.time_sig[0],n=null,d=a.harmony_progresser(g),null==p&&(p=a.scale_class.maj),r={0:c.tempo},i={0:c.key_sig},s={0:c.time_sig},null==h&&(h=null!=(m=a.keyToPitch(c.key_sig+"4"))?m:60),l=h,o=j.data.map(function(b,e){var f,g,j,m;return j=[],f=0,g=[],b.forEach(function(a){return null==a.ctrl?"number"==typeof a.dur?(f+=a.dur,g.push(a.dur)):(f+=a.dur.original,g.push(a.dur.original)):null!=a.t?q=a.t[0]*c.ctrl_per_beat:void 0}),m=Math.floor(q/f),f=0,b.forEach(function(a){if(null==a.ctrl)return"number"==typeof a.dur?(a.dur*=m,f+=a.dur):(a.dur.original*=m,f+=a.dur.original)}),b.forEach(function(b){var c,f,g,m,o,q;if(null==b.ctrl)return m=[],b.pitch.forEach(function(a){if("string"==typeof a);else{if(null==n)return m.push(k(a,l,p));if(null!=n[a-1])return m.push(n[a-1])}}),"number"==typeof b.dur?(j.push([b.dur,m]),d.forward(b.dur)):(j.push([b.dur.original,m,!0]),d.forward(b.dur.original));switch(b.ctrl){case"reset":return l=h;case"normal":case"repeat_start":o=[];for(g in b)switch(q=b[g],g){case"t":o.push(s[e]=q);break;case"s":o.push(p=a.scale_class[q]);break;case"k":i[e]=q,o.push(l=h=a.keyToPitch(q+4));break;case"r":o.push(r[e]=q);break;case"v":o.push(1);break;case"o":o.push(1);break;case"i":o.push(1);break;case"p":o.push(l+=q);break;default:o.push(void 0)}return o;case"chord":return l=a.keyToPitch("C3"),d.process(),c=d.bass(b.inv),f=d.chord(b.inv),l+=b.transpose,c+=l,n=b.pitch.map(function(a){return k(a,c,f)})}}),f<q&&(console.log("not enough"),j[j.length-1][0]+=q-f),j}),o.info={time_sigs:s,key_sigs:i,tempi:r},o},this.MG=a}.call(this),function(){var a,b,c,d,e;b=this.MG||"undefined"!=typeof module&&null!==module&&"undefined"!=typeof require&&null!==require&&require("./musical").MG||{},e=function(){function a(){this.harmony=[],this.instrs=[],this.tracks=[],this.playing=[],this.cur_i=[],this.midi=null,this.raw_midi="",this.onend=function(a){return console.log("track "+a+" finished")}}return a.prototype.play=function(a){var b,c,d,e,f,g,h,i,j;null==a&&(a=0),null==this.tracks[a]||this.tracks[a].length<=0||(i=this.tracks[a],f=this.cur_i[a],d=this.cur_i,c=i[f],f++,b=a,j=1,g=this.onend,h=this.playing,h[a]=!0,e=function(k){return function(){var l,m;c[0]>0&&(m="object"!=typeof c[1]?[c[1]]:c[1],m.forEach(function(a){a>=21&&a<=108&&MIDI.noteOn(b,a,c[2])})),l=c[0]>=0?c[0]:-c[0],l*=j,setTimeout(function(){m="object"!=typeof c[1]?[c[1]]:c[1],f<0?(m.forEach(function(a){a>=21&&a<=108&&MIDI.noteOff(b,a)}),h[a]=!1,g.call(k,a)):(i[f][0]>0&&m.forEach(function(a){a>=21&&a<=108&&MIDI.noteOff(b,a)}),c=i[f],h[a]?(f++,f>=i.length&&(f=-1,d[a]=0)):(d[a]=f,f=-1),e())},l)}}(this),setTimeout(e,0))},a.prototype.toQ=function(a,b,c){var d,e,f,g,h,i;for(e=null!=(h=a.info)?h:{},null==c&&(c=110),g=_.flatten(a,!0),i=[],f=0;f<g.length;){for(d=g[f][0];g[f][2]===!0&&f+1<g.length;)f++,d+=g[f][0];i.push([d*b,g[f][1],c]),++f}return i},a.prototype.pause=function(a){null==a&&(a=0),a>=this.tracks.length||a<0||(this.playing[a]=!1)},a.prototype.stop=function(a){null==a&&(a=0),a>=this.tracks.length||(this.playing[a]=!1,this.cur_i[a]=0)},a.prototype.fromScore=function(a){var c,d,e,f;for(c=a.init_ctrlTicks,this.tracks=[],this.instrs=b.clone(a.instrs),this.playing=[],this.cur_i=[],this.harmony=a.harmony,this.midi=a.toMidi(),this.raw_midi=MidiWriter(this.midi),d=e=0,f=a.tracks.length;e<f;d=e+=1)this.tracks.push(this.toQ(a.tracks[d],c,a.volumes[d])),this.playing.push(!1),this.cur_i.push(0)},a.prototype.saveMidi=function(){var a;this.raw_midi.length<1||(a=new Uint8Array(this.raw_midi.split("").map(function(a){return a.charCodeAt(0)})),saveAs(new Blob([a],{type:"audio/midi"}),"sample.mid"))},a}(),a=function(){function a(a,c){this.key_sig=a,this.scale_name=c,this.scale=b.scale_class[this.scale_name],this.key_ref=b.key_class[this.key_sig],this.toScale=b.pitchToScale(this.scale_name,this.key_sig),this.key_sig_acc=b.key_sig[this.key_sig]}return a.prototype.pitch_info=function(a,c){var d,e,f,g,h,i,j;if(e={},null!=c){"string"==typeof c&&(c=b.getChords(c,3,this.key_sig)),e.isChordTone=!1,h=c[1];for(d in h)if(g=h[d],(c[0]+g-a)%12===0){e.isChordTone=!0;break}}return j=this.toScale(a),e.inScale=0===j[2],f=b.scale_keys[s.key_sig][j[0]],i=b.key_sig[this.key_sig]>=0,e.keyName=e.inScale?[f,Math.floor(a/12)-({Cb:0,"B#":2}[f]||1)]:b.pitchToKey(a,i),e},a}(),d=function(a){return b.obj_sort(a,!0)},b.midi_statistics=c=function(a){var c,d,e,f,g;return c={rhythm:{},melody:{one:{},two:{}},range:[]},f={},g={},d=0,e=0,a.forEach(function(a,b){var h,i,j,k;if(j=_.unzip(a),k=j[0],c.rhythm[k]=1+(c.rhythm[k]||0),k=j[1],c.range.push(_.max(k)-_.min(k)),!(k.length<2))for(h=[k[0]%12,(k[1]-k[0])%12],null==f[h]&&(f[h]=0),f[h]++,d++,i=2;i<k.length;)h=[k[i-1]%12,(k[i]-k[i-1])%12],f[h]=1+(f[h]||0),d++,h=[k[i-2]%12,(k[i-1]-k[i-2])%12,h[1]],g[h]=1+(g[h]||0),e++,++i}),c={rhythm:b.obj_sort(c.rhythm,!0),melody:{one:b.obj_sort(f,!0),two:b.obj_sort(g,!0),n:[0,d,e]},range:c.range}},this.AppMG=function(){function a(a,b){var c,d;this.ui=a,d=$(this.ui.tracks_container),c=$(this.ui.options_container),this.tracks_tabs=d.children(".nav-tabs"),this.tracks_contents=d.children(".tab-content"),this.options_tabs=c.children(".nav-tabs"),this.options_contents=c.children(".tab-content"),this.renderer=new ScoreRenderer(this.ui.renderer[0],(void 0),this.ui.renderer[1]),this.editor={},this.ui.editor[0].forEach(function(a){return function(b,c){var d,e,f;return f="track_"+c,e=$('<li data-toggle="tab" data-target="#'+f+'"><a href="#'+f+'">'+b[0].toUpperCase()+b.substr(1)+"</a></li>"),e.children().append($('<span class="glyphicon glyphicon-play"></span>')),a.tracks_tabs.children("li.tab_plus").before(e),e=$('<div class="tab-pane" id="'+f+'"><div class="editor" id="ace_'+b.toLowerCase()+'" style="height:300px"></div></div>'),a.tracks_contents.append(e),d=ace.edit("ace_"+b.toLowerCase()),d.setTheme("ace/theme/clouds"),d.getSession().setMode("ace/mode/"+a.ui.modes[0][c]),d.setFontSize(16),d.$blockScrolling=1/0,a.editor[b]=d}}(this)),this.tracks_tabs.children().first().addClass("active"),this.tracks_contents.children().first().addClass("active in"),this.ui.editor[1].forEach(function(a){return function(b,c){var d,e,f;return f="options_"+c,e=$('<li data-toggle="tab" data-target="#'+f+'"><a href="#'+f+'">'+b[0].toUpperCase()+b.substr(1)+"</a></li>"),a.options_tabs.children("li.tab_plus").before(e),e=$('<div class="tab-pane" id="'+f+'"><div class="editor" id="ace_'+b.toLowerCase()+'" style="height:300px"></div></div>'),a.options_contents.append(e),d=ace.edit("ace_"+b.toLowerCase()),d.setTheme("ace/theme/clouds"),d.getSession().setMode("ace/mode/"+a.ui.modes[1][c]),d.getSession().setUseWrapMode(!0),d.setFontSize(14),d.$blockScrolling=1/0,a.editor[b]=d}}(this)),this.options_tabs.children().first().addClass("active"),this.options_contents.children().first().addClass("active in"),this.player=null,this.playbtns=this.ui.playbtns.map(function(a){return function(b,c){var d;return d=$(b+">span.glyphicon"),d.on("click",function(){return a.play(c)}),d}}(this)),this.reset(b)}return a.prototype.reset=function(a){var c,d,f,g,h,i;if(null!=a){switch(i=a.version,null==i&&(i="0.1"),i){case"0.1":this.schema=a.schema,this.settings=a.settings,this.contents=a.contents;break;case"0.2":for(this.schema=a.schema,this.settings=a.settings,this.contents={},h=a.contents,d=0,f=h.length;d<f;d++)c=h[d],this.contents[c.mode]=c.data;this.contents.harmony=a.harmony}this.obj=a}else this.schema=b.circularClone(b.schema_summer),this.settings=b.circularClone(b.score_summer.settings),this.contents=b.circularClone(b.score_summer.contents),this.obj=null;return g=this.playbtns,this.player=new e,this.player.onend=function(a){var b;if(b=this.cur_i[a],!(b>0&&b<this.tracks[a].length))return g[a].toggleClass("glyphicon-play glyphicon-pause")},this.updateEditor()},a.prototype["export"]=function(){return{version:"0.2",settings:this.settings,schema:this.schema,harmony:this.contents.harmony,contents:[{mode:"melody",data:this.contents.melody},{mode:"texture",data:this.contents.texture}]}},a.prototype.updateEditor=function(){return _.flatten(this.ui.editor).forEach(function(a){return function(c){var d;d="schema"===c?b.schema_parser.produce(a.schema):null!=a.contents[c]?a.contents[c].join("\n"):JSON.stringify(a[c],null,2),a.editor[c].setValue(d,-1)}}(this))},a.prototype.play=function(a){return this.player.playing[a]?this.player.pause(a):this.player.play(a),this.playbtns[a].toggleClass("glyphicon-play glyphicon-pause")},a.prototype.parse=function(){var a,c,d;try{this.settings=JSON.parse(this.editor.settings.getValue())}catch(c){a=c,$.notify("Bad score format!","warning")}try{this.schema=b.schema_parser.parse(this.editor.schema.getValue())}catch(d){a=d,console.log(a.message),$.notify("Bad schema format!","warning")}return["melody","harmony","texture"].forEach(function(a){return function(b){return a.contents[b]=a.editor[b].getValue().split(/[\n]+/)}}(this)),this.obj=new ScoreObj(this.settings,this.contents),this.player.fromScore(this.obj),this.obj},a.prototype.generate=function(){var a,c,d,e;this.settings=JSON.parse(this.editor.settings.getValue());try{this.schema=b.schema_parser.parse(this.editor.schema.getValue())}catch(c){a=c,console.log(a.message),$.notify("Bad schema format!","warning")}return d=new Generator(this.settings,this.schema),d.generate(),e=d.toScoreObj(),this.contents.melody=e.toText(),this.contents.harmony=e.harmony_text,this.updateEditor()},a.prototype.analysis=function(a,d){var e,f,g,h,i,j;return null==a&&(a=MIDI.Player.currentData),null==d&&(d=8),f=MidiFile(a),i={key_sig:b.key_sig_rev[f.getKeySignature()[0]],time_sig:f.getTimeSignature(),ctrl_per_beat:d},h=f.quantize(d),j=h.map(function(a){var b,e,f,g;return e=[],g=[],b=0,a.forEach(function(a){a[0]>b&&(g.length>0?(e.push([a[0]-b,g]),g=[]):e.push([a[0]-b,[0]]),b=a[0]),"noteOn"===a[1]&&0!==a[3]?g.push(a[2]):"timeSignature"===a[1]?console.log("time_sig change",a):"keySignature"===a[1]&&console.log("key_sig change",a)}),e=_.unzip(e),e={dur:e[0],pitch:e[1]},f=Generator.prototype.b2score.call({},e,d*i.time_sig[0]),f.info=c(Generator.prototype.b2score.call({},e,d)),f}),g=new ScoreObj(i),g.setMelody(j[0],!0),g.setTexture(j[1],[],!0),this.obj=g,this.editor.settings.setValue(JSON.stringify(this.obj.getSettings(),null,2),-1),this.editor.melody.setValue(this.obj.toText().join("\n"),-1),e=j.map(function(a){return a.info}),b.ref_midi_info=e[0],e},a}()}.call(this),function(){var a,b,c=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1},d=function(a,b){return(+a%(b=+b)+b)%b};a=this.MG||"undefined"!=typeof module&&null!==module&&"undefined"!=typeof require&&null!==require&&require("./musical").MG||{},a.ref_midi_info=null,b=a.schema_parser,this.Generator=function(){function b(b,c){var d,e,f,g,h,i;this.settings=b,this.schema=c,null==(d=this.settings).key_sig&&(d.key_sig="C"),null==(e=this.settings).scale&&(e.scale="maj"),null==(f=this.settings).instrs&&(f.instrs=[1,1]),this.keyref=a.keyToPitch[this.settings.key_sig+"4"],this.scale=a.scale_class[this.settings.scale],this.seeds={},h=this.schema;for(g in h)i=h[g],null!=i.mode&&"distribution"===i.mode&&(this.seeds[g]=i);this.res={},this.toPitch=a.scaleToPitch(this.settings.scale,this.settings.key_sig),this.toScale=a.pitchToScale(this.settings.scale,this.settings.key_sig),this.map_gen={random:this.gen_random,exact:this.gen_exact,skeleton:this.gen_skeleton,distribution:function(a){return a}},this.map_act={transpose:this.act_transpose,reverse:this.act_reverse,diminution:this.act_dim,augmentation:this.act_aug,"double":this.act_double,acciaccatura:this.act_acciaccatura}}var e,f,g;return g=a.seededRandom,f=a.rndPicker,b.prototype.produce=function(b,d){var e,f,g,h,i,j,k,l,m,n,o,p,q,r;if(null!=b.mode){if(null!=this.map_gen[b.mode])return this.map_gen[b.mode].call(this,b);console.log("unrecognized generating mode")}null==b.node&&(b.node={}),null==b.action&&(b.action={}),null==d&&(d={}),k=_.keys(b.node),e={},o=b.node;for(g in o)if(r=o[g],e[g]=[],null==r.mode)for(null==r.node&&(r.node={}),p=r.structure,h=0,i=p.length;h<i;h++)f=p[h],!(f in r.node)&&c.call(k,f)>=0&&e[g].push(f);for(k=a.top_sort(e),m=Object.assign({},d),n=0,j=k.length;n<j;n++)g=k[n],m[g]=this.produce(b.node[g],m);return q=new Snippet,l={},b.structure.forEach(function(c){return function(d,e){var f,g,h;return d in m?(h=m[d],f=null,"_"+e+"_"+d in b.action&&(g=b.action["_"+e+"_"+d],null!=g.modify&&(f=g.modify),null!=c.map_act[g.mode]?h=c.map_act[g.mode].call(c,g,h):console.log("unsupported action",g.mode)),q=q.join(h,l),l=null!==f?a.clone(f):{}):console.log("miss",d)}}(this)),null!=l.cadence&&q.cadence(l.cadence),q},b.prototype.generate=function(){return this.snippet=this.produce(this.schema.S),console.log(this.snippet),this.res2=this.snippet.toScore(this.settings.key_sig),console.log("score",this.res2),this.res2},b.prototype.evaluate=function(b){var c,d,e,f,g;if(c=a.midi_statistics(b),console.log("eval",b,c),g={},0!==c.rhythm.length)return e=0,c.rhythm.forEach(function(a){return e+=a[1]}),g.simp=c.rhythm[0][1]/e,g.range=_.max(c.range),console.log("report",g.simp,g.range),null!==a.ref_midi_info&&(f=math.sum(a.ref_midi_info.rhythm[0][0].split(",")),d=math.sum(c.rhythm[0][0].split(",")),console.log("compare",d,f)),c},e=function(a,b,c){var d;return d={},b.forEach(function(b,e){d[a+b]=c[e]}),d},b.prototype.act_transpose=function(b,c){var d,e,f,g,h,i,j,k,l,m;for(e=b.dur,j=new Snippet,k=c.data,g=null!=(h=b.key_sig)?h:this.settings.key_sig,null==b.scale&&(b.scale="chromatic"),m=a.transposer(b.scale,g),f=b.interval,"number"==typeof f&&(f=[f]),i=0,d=0;e>0;)i>=k.length&&(i-=k.length,d=(d+1)%f.length,console.log("shift to next interval")),l=new Measure(k[0].time_sig,k[0].tatum),l.harmony=a.clone(k[i].harmony),l.harmony.forEach(function(a){return a[1]=m(a[1],f[d])}),k[i].dur.forEach(function(a,b){e-a>=0?(l.dur.push(a),l.pitch.push(m(k[i].pitch[b],f[d])),e-=a):e>0&&(l.dur.push(e),l.pitch.push(m(k[i].pitch[b],f[d])),e=0)}),j.data.push(l),i++;return console.log(c,"transpose-> ",j),j},b.prototype.act_reverse=function(a,b){var c;return c=b.copy(),null!=a.deep&&a.deep===!0?c.data.reverse().forEach(function(a){if(a.pitch.reverse(),a.dur.reverse(),null!=a.harmony)return a.harmony.reverse()}):c.data.reverse(),console.log(b,"reverse-> ",c),c},b.prototype.act_double=function(b,c){var d,e,f,g;return g=new Snippet,d=[],e=null!=(f=b.div)?f:3,c.data.forEach(function(c){var f,g;g=c.copy(),g.pitch=[],g.dur=[],f=a.gcd.apply(null,c.dur),c.dur.forEach(function(a,d){var f;return null==b.force?null!=b.num&&d>b.num?g.add(c.pitch[d],a):(f=Math.ceil(a/e),g.add(c.pitch[d],a-f),g.add(c.pitch[d],f)):a>b.force?(f=Math.floor(a/b.force),g.add(c.pitch[d],a-f),f>0?g.add(c.pitch[d],f):void 0):g.add(c.pitch[d],a)}),d.push(g)}),g.data=d,console.log(c,"double->",g),g},b.prototype.act_acciaccatura=function(b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p;return n=new Snippet,e=[],d=null!=(i=b.ctrl_per_beat)?i:this.settings.ctrl_per_beat,f=null!=(j=b.delay)?j:Math.ceil(d/3),g=null!=(k=b.key_sig)?k:this.settings.key_sig,o=null!=(l=b.scale)?l:"maj",h=null!=(m=b.num)?m:3,p=a.transposer(o,g),c.data.forEach(function(d,g){var i,j,k,l,m,n;for(n=d.copy(),n.pitch=[],n.dur=[],i=j=0,m=d.dur.length-1;j<m;i=j+=1)d.dur[i]>f&&i<h?(n.add(d.pitch[i],d.dur[i]-f),a.seededRandom()>.4?n.add(d.pitch[i+1]-1,f):(k=p(d.pitch[i+1],1),n.add(k,f))):n.add(d.pitch[i],d.dur[i]);g<c.data.length-1&&null!=b.tailbite?(l=Math.ceil(d.dur[d.dur.length-1]/3),n.add(d.pitch[d.pitch.length-1],d.dur[d.dur.length-1]-l),l>0&&n.add(c.data[g+1].pitch[0],l)):n.add(d.pitch[d.pitch.length-1],d.dur[d.dur.length-1]),e.push(n)}),n.data=e,console.log(c,"acciaccatura->",n),n},b.prototype.act_aug=function(a,b){},b.prototype.act_dim=function(a,b){},b.prototype.gen_skeleton=function(b){var c,d,e,f,g,h,i,j,k,l,m,n;return c=null!=(j=b.ctrl_per_beat)?j:this.settings.ctrl_per_beat,f={ctrl_per_beat:c},g=null!=(k=b.key_sig)?k:this.settings.key_sig,n=null!=(l=b.time_sig)?l:this.settings.time_sig,f.key_sigs={0:g},f.time_sigs={0:n},e=a.parseHarmony(b.chords,f),i=a.keyToPitch(g+"4"),
d=[],h=[],null!=b.eachbeat&&b.eachbeat===!0?e.forEach(function(b){return b.forEach(function(b){var e;for(e=b[0];e>=c;)d.push(c),h.push(b[1]+b[2][Math.floor(a.seededRandom()*b[2].length)]),e-=c;return e>0&&(d.push(e),h.push(b[1]+b[2][Math.floor(a.seededRandom()*b[2].length)])),b[2]=a.chord_finder[b[2].toString()]||"maj"})}):e.forEach(function(b){return b.forEach(function(b){return d.push(b[0]),h.push(b[1]+b[2][Math.floor(a.seededRandom()*b[2].length)]),b[2]=a.chord_finder[b[2].toString()]||"maj"})}),m=new Snippet(h,d,e,{time_sig:n,tatum:c}),console.log("gen skeleton",f,m),m},b.prototype.gen_exact=function(b){var c,d,e,f;return b=a.clone(b),null==b.ctrl_per_beat&&(b.ctrl_per_beat=this.settings.ctrl_per_beat),null==b.tempo&&(b.tempo=this.settings.tempo),null==b.time_sig&&(b.time_sig=this.settings.time_sig),null==b.key_sig&&(b.key_sig=this.settings.key_sig),console.log("gen exact",f=a.parseMelody(b.score,b)),e={ctrl_per_beat:this.settings.ctrl_per_beat},e.key_sigs={0:this.settings.key_sig},e.time_sigs={0:this.settings.time_sig},d=a.parseHarmony(b.chords,e),c=f.map(function(c,e){var f;return f=new Measure(b.time_sig,b.ctrl_per_beat),c.forEach(function(a){return f.add(a[1][0],a[0])}),d[e].forEach(function(b){return b[2]=a.chord_finder[b[2].toString()]||"maj"}),f.harmony=d[e],f}),f=new Snippet,f.data=c,f},b.prototype.gen_random=function(b){var c,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P;for(k=b.dur,N=this.toPitch,O=this.toScale,i=null!=(D=b.ctrl_per_beat)?D:this.settings.ctrl_per_beat,o={ctrl_per_beat:i},r=null!=(E=b.key_sig)?E:this.settings.key_sig,L=null!=(F=b.time_sig)?F:this.settings.time_sig,o.key_sigs={0:r},o.time_sigs={0:L},null==b.chords&&(u=Math.ceil(k/i/L[0]),l=a.chord_hmm(r),b.chords=l.gen(u),console.log("GENERATE CHORDS",b.chords)),m=a.parseHarmony(b.chords,o),h=a.harmony_progresser(m),H=this.scale.length,G={dur:[],pitch:[]},I={},null!=b.rhythm.seed&&null!=this.seeds?I=this.seeds[b.rhythm.seed]:(I.dur=b.rhythm[0],I.choices=b.rhythm[1],I.weights=b.rhythm[2]),J={},J=null!=b.interval.seed&&null!=this.seeds?this.seeds[b.interval.seed]:b.interval,y=b.range,null==y&&(y=[48,90]),z=function(a){return a<y[0]||a>y[1]?0:.25+3*(a-y[0])*(y[1]-a)/Math.pow(y[1]-y[0],2)},null!=b.dist&&"linear"===b.dist&&(z=function(a){return a<y[0]||a>y[1]?0:1-2*Math.abs(a-(y[0]+y[1])/2)/(y[1]-y[0])}),K=b.rhythm.swarp,null==K&&(K=1),s=Math.floor(k/Math.floor(I.dur/K)),B=f(I.choices,I.weights),w=4*H,x=w,n=0;n<s;){for(t=B.gen().map(function(a){return Math.floor(a/K)}),G.dur.push(t),M=[],p=0;p<G.dur[n].length;){h.process(),j=h.chord(),c=h.bass(),A=e(w,J.choices,J.weights),g={};for(q in A)P=A[q],q>=0&&q<=8*H&&(q=N(q),P*=z(q),null!=b.chord_tone&&j.forEach(function(a,e){if(d(q-c,12)===a)return P*=b.chord_tone}),null!=b.scale_tone&&console.log("scale tone"),g[q]=P);C=f(_.keys(g),_.values(g)),w=parseInt(C.gen()),M.push(w),w=O(w),w=w[0]+w[1]*H,h.forward(G.dur[n][p]),++p}G.pitch.push(M),++n}return v={time_sig:this.settings.time_sig,tatum:this.settings.ctrl_per_beat},null!=b.incomplete_start&&(v.incomplete_start=b.incomplete_start),m.forEach(function(b){return b.forEach(function(b){return b[2]=a.chord_finder[b[2].toString()]||"maj"})}),G=new Snippet(G.pitch,G.dur,m,v)},b.prototype.b2score=function(a,b){var c,d,e,f,g;return d=_.flatten(a.dur,!0),e=_.flatten(a.pitch,!0),f=[],g=[],c=0,d.forEach(function(a,d){for(;c+a>b;)g.push([b-c,e[d],!0]),f.push(g),g=[],a-=b-c,c=0;if(g.push([a,e[d]]),c+=a,c===b)return f.push(g),g=[],c=0}),g.length>0&&f.push(g),f},b.prototype.toScoreObj=function(){var a,b,c,d;return 0===_.keys(this.res2).length&&this.generate(),d=this.res2,a=this.res2.map(function(a){return a.harmony}),c=new ScoreObj(this.settings),b=d,b.info={time_sigs:{0:this.settings.time_sig},key_sigs:{0:this.settings.key_sig},tempi:{0:this.settings.tempo}},c.setMelody(b,!0),c.harmony_text=a,c},b}()}.call(this),function(){var a,b,c,d=function(a,b){return(+a%(b=+b)+b)%b};a=this.MG||"undefined"!=typeof module&&null!==module&&"undefined"!=typeof require&&null!==require&&require("./musical").MG||{},c=a.score_parser,this.Measure=function(){function b(a,b){this.time_sig=a,this.tatum=b,this.pitch=[],this.dur=[],null==this.time_sig&&(this.time_sig=[4,4]),null==this.tatum&&(this.tatum=8)}return b.prototype.copy=function(c){return 0===arguments.length?(c=new b(a.clone(this.time_sig),this.tatum),c.pitch=a.clone(this.pitch),c.dur=a.clone(this.dur),a.condCopy(this,c,["tie","incomplete_start","harmony"]),c):(this.time_sig=a.clone(c.time_sig),this.tatum=c.tatum,this.pitch=a.clone(c.pitch),this.dur=a.clone(c.dur),a.condCopy(c,this,["tie","incomplete_start","harmony"]))},b.prototype.add=function(a,b){this.pitch.push(a),this.dur.push(b)},b.prototype.note=function(a){return[this.dur[a],this.pitch[a]]},b.prototype.last=function(){return this.note(this.len()-1)},b.prototype.first=function(){return this.note(0)},b.prototype.setNote=function(a,b){return this.dur[a]=b[0],this.pitch[a]=b[1]},b.prototype.len=function(){return this.dur.length},b.prototype.incomplete=function(){return math.sum(this.dur)<this.tatum*this.time_sig[0]},b.prototype.overflow=function(){return math.sum(this.dur)>this.tatum*this.time_sig[0]},b.prototype.pos=function(a,b){var c,d;if(0===this.dur.length)return null;for(null==b&&(b=0),d=a*this.tatum+b,c=0;c<this.dur.length&&d>0;)d-=this.dur[c],c++;return d<0&&c--,c>=this.dur.length&&(c=this.dur.length-1),this.pitch[c]},b}(),this.Snippet=function(){function b(b,c,d,e){var f,g,h,i,j,k,l,m,n,o;if(0===arguments.length)return void(this.data=[]);for(;"number"!=typeof c[0];)c=_.flatten(c,!0),b=_.flatten(b,!0);n=null!=(i=e.tatum)?i:8,o=null!=(j=e.time_sig)?j:[4,4],m=n*o[0],a.condCopy(e,this,["incomplete_start","tie"]),f=null!=(k=this.incomplete_start)?k:m,g=0,h=new Measure(o,n),l=[],c.forEach(function(a){return function(a,c){var e;if(!(f-a>=0)){for(e=[];f<a;)h.dur.push(f),h.pitch.push(b[c]),h.tie=!0,h.harmony=d[g],l.push(h),a-=f,f=m,h=new Measure(o,n),e.push(g++);return e}if(h.pitch.push(b[c]),h.dur.push(a),f-=a,0===f)return h.harmony=d[g],l.push(h),g++,h=new Measure(o,n),f=m}}(this)),f<m&&(this.incomplete_end=m-f,h.harmony=d[g],l.push(h)),this.data=l}return b.prototype.last=function(){return 0===this.data.length?null:this.data[this.data.length-1]},b.prototype.first=function(){return 0===this.data.length?null:this.data[0]},b.prototype.copy=function(c){return 0===arguments.length?(c=new b,c.data=this.data.map(function(a){return a.copy()}),a.condCopy(this,c,["incomplete_start","tie"]),c):(this.data=c.data.map(function(a){return a.copy()}),a.condCopy(c,this,["incomplete_start","tie"]))},b.prototype.join=function(b,c){var d,e,f,g,h,i,j,k;return j=this.copy(),b=b.copy(),j.data.length>0&&(null!=c&&null!=c.smooth&&(f=j.last(),d=b.first(),console.log("new smooth",f,d),g=f.last(),e=d.first(),f.len()>1&&(i=f.note(f.len()-2),(g[1]>i[1]&&g[1]>e[1]||g[1]<i[1]&&g[1]<e[1])&&(f.setNote(f.len()-2,g),g=i,i=f.note(f.len()-2))),g[1]-e[1]<=-12?g[1]+=12:g[1]-e[1]>=12&&(g[1]-=12),f.setNote(f.len()-1,g),console.log("smooth",f,d)),k=j.data.pop(),h=null,null!=this.incomplete_end&&null!=b.incomplete_start?(h=new Measure,h.harmony=a.clone(k.harmony),null==h.harmony&&(h.harmony=[]),h.pitch=k.pitch.concat(b.data[0].pitch),h.dur=k.dur.concat(b.data[0].dur),null!=b.data[0].harmony&&(h.harmony=h.harmony.concat(b.data[0].harmony)),null!=b.data[0].tie&&b.data[0].tie===!0&&(h.tie=b.data[0].tie),b.data.shift()):h=k.copy(),j.data.push(h)),j.data=j.data.concat(b.data),a.condCopy(b,j,["incomplete_end"]),console.log("join snippet",j.data,c),j},b.prototype.cadence=function(b){var c,e,f,g,h;if(e=this.last(),e.dur.sort(),h=a.key_class[b],f=e.last(),c=d(h-f[1]%12,12),c>6&&(c-=12),f[1]+=c,console.log(c,"adjust->",f),!(e.len()>1&&(g=e.note(e.len()-2),f[1]-g[1]>=12&&(f[1]-=12),f[1]===g[1])))return e.setNote(e.len()-1,f)},b.prototype.toScore=function(b){var c;return null==b&&(b="C"),c=a.key_sig[b]>=0,this.data.map(function(b){var d,e,f;return f=_.zip(b.dur,b.pitch),null!=b.tie&&(b.tie=!0)&&f[f.length-1].push(!0),null==b.harmony&&(b.harmony=[]),d=b.harmony.map(function(a){return a[0]}),e=a.gcd.apply(null,d),e>1&&b.harmony.forEach(function(a){return a[0]/=e}),f.harmony=b.harmony.map(function(b){var d;return d=a.pitchToKey(b[1],c,!0)+b[2],b[0]>1&&(d+=","+b[0]),d}).join(" "),f})},b}(),b=this.ScoreObj=function(){function b(b,c){null==b&&(b={}),this.tempo=b.tempo,this.time_sig=b.time_sig,this.key_sig=b.key_sig,this.ctrl_per_beat=b.ctrl_per_beat,this.scale=b.scale,this.volumes=b.volumes,this.instrs=b.instrs,null==this.tempo&&(this.tempo=120),null==this.time_sig&&(this.time_sig=[4,4]),null==this.key_sig&&(this.key_sig="C"),null==this.ctrl_per_beat&&(this.ctrl_per_beat=4),null==this.scale&&(this.scale="maj"),null==this.volumes&&(this.volumes=[110,80]),null==this.instrs&&(this.instrs=[1,1]),this.init_ref=a.scaleToPitch(this.scale,this.key_sig)(4*a.scale_class[this.scale].length),this.init_ctrlTicks=6e4/this.tempo/this.ctrl_per_beat>>>0,this.tracks=[],this.harmony=[],this.harmony_text=[],null!=c&&(null!=c.melody&&this.setMelody(c.melody,!1),null!=c.harmony&&null!=c.texture&&(this.harmony_text=c.harmony,this.setTexture(c.texture,c.harmony)))}return b.prototype.getSettings=function(){return{tempo:this.tempo,time_sig:this.time_sig,key_sig:this.key_sig,ctrl_per_beat:this.ctrl_per_beat,scale:this.scale,volumes:this.volumes,instrs:this.instrs}},b.prototype.setTrack=function(a,b){return a>this.tracks.length&&console.log("track number overflow"),this.tracks[a]=b},b.prototype.setMelody=function(b,c){var d;return null!=c&&c===!0?this.setTrack(0,b):(d=this.getSettings(),d.scale=a.scale_class[d.scale],d.init_ref=this.init_ref,this.setTrack(0,a.parseMelody(b,d)))},b.prototype.setTexture=function(b,c,d){var e,f;return null!=d&&d===!0?(this.harmony=c,this.setTrack(1,b)):(e=null,null!=this.tracks[0].info&&(e=a.clone(this.tracks[0].info)),e.ctrl_per_beat=this.ctrl_per_beat,this.harmony=a.parseHarmony(c,e),f=this.getSettings(),f.harmony=this.harmony,this.setTrack(1,a.parseMelody(b,f)))},b.prototype.setPercussion=function(a,b){},b.prototype.toText=function(b){var c,d,e,f,g;return console.log("to score text"),null==b&&(b=a.clone(this.tracks[0])),f=b.info.time_sigs,c=b.info.key_sigs,null==b?void console.log("null melody"):(g=a.pitchToScale(this.scale,this.key_sig),d=4,e=b.map(function(b,e){var h,i,j;return j=[],null!=f[e]&&j.push(":t"+f[e].join("/")),null!=c[e]&&j.push(":k"+c[e]),h=b.map(function(a){return a[0]}),i=a.gcd.apply(null,h),i>1&&b.forEach(function(a){a[0]/=i}),b.forEach(function(a){var b;return b="","object"!=typeof a[1]&&(a[1]=[a[1]]),a[1].forEach(function(a){var c,e;if(a<21||a>108)return b+="0";if(e=g(a),c=e[1]-d,c<-1||c>1){for(b+=":";c<-1;)b+="-",d--,c++;for(;c>1;)b+="+",d++,c--;b+=" "}return b+=1+e[0],b+={"-1":"-",1:"+"}[c]||"",b+={1:"#",2:"##"}[e[2]]||""}),a[2]===!0&&(a[0]=(a[0]+"^").replace("^^","^")),("string"==typeof a[0]||a[0]>1)&&(b+=","+a[0]),j.push(b)}),j.join(" ")}))},b.prototype.harmony_roman=function(){var b,c;return c=a.keyToRoman(this.key_sig),b=/[A-G][b#]{0,2}/,this.harmony_text=this.harmony_text.map(function(a,d){return a.split(/\s+/).map(function(a){var d;return d=b.exec(a),null===d?a:a.replace(d[0],c(d[0])).replace(/b#/g,"").replace(/#b/g,"")}).join(" ")}),this.harmony_text.join("\n")},b.prototype.toMidi=function(){var b,c,d,e,f,g,h,i,j,k,l,m,n,o;for(b=this.init_ctrlTicks,h=new simpMidi,h.setTimeSignature(this.time_sig[0],this.time_sig[1]),h.setKeySignature(a.key_sig[this.key_sig],"maj"),h.setTempo(this.tempo),h.setDefaultTempo(this.tempo),i=this.tracks.length,i>9&&(i=9),n=this.tracks[0].info.time_sigs,g=this.tracks[0].info.key_sigs,m=f=0,k=i;f<k;m=f+=1)e=0,0!==m&&(h.addTrack(),console.log("add track",m)),console.log("info",this.tracks[m].info),o=null!=(l=this.volumes[m])?l:this.volumes[0],MIDI.programChange(m,this.instrs[m]-1),h.addEvent(m+1,0,"programChange",m,this.instrs[m]-1),j=[],d=0,c=0,this.tracks[m].forEach(function(f,i){var k,l,p;for(0===m&&(null!=n[i]&&(h.addEvent(0,e*b,"timeSignature",n[i][0],n[i][1]),e=0),null!=g[i]&&(h.addEvent(0,e*b,"keySignature",a.key_sig[g[i]],"maj"),e=0)),l=0,p=[];l<f.length;)k=f[l],e+=k[0],0===j.length&&("number"==typeof k[1]?k[1]>=21&&k[1]<=108&&(j.push=k[1]):k[1].forEach(function(a){if(a>=21&&a<=108)return j.push(a)})),0===j.length?c+=k[0]:(d+=f[l][0],f[l][2]!==!0&&(h.addNotes(m+1,d*b,j,o,0,c*b),j=[],d=0,c=0)),p.push(++l);return p}),j.length>0&&(console.log("remain",j),h.addNotes(m+1,d*b,j,o,0,c*b));return h.finish(),h},b}()}.call(this),function(){var a;a=this.MG||"undefined"!=typeof module&&null!==module&&"undefined"!=typeof require&&null!==require&&require("./musical").MG||{},this.ScoreRenderer=function(){function b(a,b){var c;this.c=document.getElementById(a),this.real_ctx=this.c.getContext("2d"),this.hidden_canvas=document.createElement("canvas"),this.r=new Vex.Flow.Renderer(this.hidden_canvas,Vex.Flow.Renderer.Backends.CANVAS),this.ctx=this.r.getContext(),this.geo={system_width:900,system_height:80,system_interval:50,left_padding:30,top_padding:70,reserved_width:55},this.layout={measure_per_system:4,system_per_page:5},this.numPage=1,this.currentPage=1,this.measures=[],this.pages=[],c=$("#midi_pager"),this.UI={prev:c.find(".prev"),next:c.find(".next"),page_num:c.find(".page_num"),page_count:c.find(".page_count")},this.UI.prev.on("click",function(a){return function(){if(!(a.currentPage<=1))return a.currentPage--,a.renderPage(a.currentPage-1)}}(this)),this.UI.next.on("click",function(a){return function(){if(!(a.currentPage>=a.numPage))return a.currentPage++,a.renderPage(a.currentPage-1)}}(this)),null!=b&&(this.p=new fabric.StaticCanvas(b,{width:$(".canvas-wrapper").width(),height:2*$(".canvas-wrapper").width(),backgroundColor:"rgba(240,250,240, 5)"}))}var c,d;return b.prototype.newStave=function(a,b){var c,d,e,f,g;return null==b&&(b="treble"),c=a%this.layout.measure_per_system,d=Math.floor(a/this.layout.measure_per_system)%this.layout.system_per_page,e=Math.floor(this.geo.system_width/this.layout.measure_per_system),f=this.geo.left_padding+c*e,g=this.geo.top_padding+d*(this.geo.system_height+this.geo.system_interval),0===c?new Vex.Flow.Stave(f,g,e).addClef(b):new Vex.Flow.Stave(f,g,e)},d=function(a,b){var c,d;for(null==b&&(b=2),d=[],c=1;a>0;)(c&a)>0&&(d.unshift(c),a-=c),c<<=1;return d},b.prototype.toBit=d,c=function(a,b){var c,e,f,g,h,i,j,k;if(0===a)return{sum:b,dur:d(b)};for(f=d(a+b),e=0,g=f.map(function(a){return e+=a}),c=0;a>g[c];)c++;if(i=f.slice(c+1),h=g[c]-a,0===h)return{sum:a+b,dur:i};for(k=d(a),k=k.slice(c),j=[];h>0;)for(j.push(k[k.length-1]),h-=j[j.length-1],k[k.length-1]*=2;k.length>1&&k[k.length-1]===k[k.length-2];)k.pop(),k[k.length-1]*=2;return i=j.concat(i),{sum:b+a,dur:i}},b.prototype.renderPage=function(a){var b,c,d,e,f,g,h,i,j,k;if(!(a<0||a>=this.numPage)){if(null!=this.pages[a])return this.real_ctx.clearRect(0,0,this.c.width,this.c.height),this.real_ctx.drawImage(this.pages[a],0,0),void this.UI.page_num.html(a+1);for(console.log("render page",a+1),this.r.resize(1e3,800),this.c.width=1e3,this.c.height=800,k=this.layout.measure_per_system*this.layout.system_per_page,h=(a+1)*k,k=h-k,h>=this.measures.length&&(h=this.measures.length),c=this.ctx,f=g=i=k,j=h;g<j;f=g+=1)d=this.measures[f],e=(new Vex.Flow.Formatter).joinVoices(d.voices).format(d.voices,d.w),d.stave.setContext(c).draw(),d.voices.forEach(function(a){return a.draw(c,d.stave)}),d.beams.forEach(function(a){return a.setContext(c).draw()}),d.ties.forEach(function(a){return a.setContext(c).draw()});return b=document.createElement("canvas"),b.width=1e3,b.height=800,b.getContext("2d").drawImage(this.hidden_canvas,0,0),this.pages[a]=b,this.real_ctx.clearRect(0,0,this.c.width,this.c.height),this.real_ctx.drawImage(this.pages[a],0,0),this.UI.page_num.html(a+1)}},b.prototype.render=function(b){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y;for(this.s=b,this.layout.measure_per_system=b.ctrl_per_beat>16?2:3,this.measures=[],l=b.tracks[0],v=null!=(o=l.info.time_sigs[0])?o:b.time_sig,j=null!=(p=l.info.key_sigs[0])?p:b.key_sig,r=a.key_sig[j]>=0,w=a.pitchToScale(b.scale,j),this.geo.reserved_width=30+5*Math.abs(a.key_sig[j]),h=i=0,q=l.length;i<q;h=i+=1){s=this.newStave(h),d=!1,y=Math.floor(this.geo.system_width/this.layout.measure_per_system),null!=l.info.key_sigs[h]&&(j=l.info.key_sigs[h],r=a.key_sig[j]>=0,w=a.pitchToScale(b.scale,j),console.log("key_sig change",j),d=!0),(d||h%this.layout.measure_per_system===0)&&(this.geo.reserved_width=28+6*Math.abs(a.key_sig[j]),s.addKeySignature(j),y-=this.geo.reserved_width),null!=l.info.time_sigs[h]&&(v=l.info.time_sigs[h],s.addTimeSignature(v.join("/")),y-=20),m=[],u=[],k=[],t=0,l[h].forEach(function(d){var e,f,g,h,i,l,n,o,p,q,s,x;if(o=c(t,16*d[0]/b.ctrl_per_beat),t=o.sum,e=o.dur,f=[],n=0,e.forEach(function(a){return a===n?f[f.length-1]+="d":f.push(""+16*v[1]/a),n=a/2}),i=[],"number"==typeof d[1]&&(d[1]=[d[1]]),d[1].forEach(function(b){var c,d;if(!(b<21||b>108))return d=w(b),c=a.scale_keys[j][d[0]],c+="/"+(Math.floor(b/12)-1+({Cb:1,"B#":-1}[c]||0)),0!==d[2]&&(c=a.pitchToKey(b,r).join("/")),null!=c?i.push(c):void 0}),q=!1,i.length<=0&&(q=!0,i.push("Bb/4"),f=f.map(function(a){return a+"r"})),f.forEach(function(a){var b,c,d,e,f;if(f=new Vex.Flow.StaveNote({keys:i,duration:a,auto_stem:!0}),d=/d+/.exec(a),null!=d)for(b=c=0,e=d[0].length;c<e;b=c+=1)f.addDotToAll();return m.push(f)}),!q&&f.length>1)for(s=m.length-f.length,h=Array(i.length).fill(0).map(function(a,b){return b}),g=l=1,p=f.length;l<p;g=l+=1)x=new Vex.Flow.StaveTie({first_note:m[s+g-1],last_note:m[s+g],first_indices:h,last_indices:h}),u.push(x);if(d[2]===!0)return k.push(m.length-1)}),k.forEach(function(a){var b,c;b=Array(m[a].keys.length).fill(0).map(function(a,b){return b}),c=new Vex.Flow.StaveTie({first_note:m[a],last_note:m[a+1],first_indices:b,last_indices:b}),u.push(c)}),n=Math.floor(t/16),x=new Vex.Flow.Voice({num_beats:n,beat_value:v[1],resolution:Vex.Flow.RESOLUTION});try{x.addTickables(m)}catch(g){f=g,console.log(f.message);continue}Vex.Flow.Accidental.applyAccidentals([x],j),e=Vex.Flow.Beam.applyAndGetBeams(x),h%this.layout.measure_per_system===0&&(y-=20),this.measures.push({w:y-10,voices:[x],stave:s,beams:e,ties:u})}return this.numPage=Math.ceil(this.measures.length/this.layout.measure_per_system/this.layout.system_per_page),this.UI.page_count.html(this.numPage),this.currentPage=1,this.pages.forEach(function(a){return function(b,c){return delete a.pages[c]}}(this)),this.pages=[],this.renderPage(this.currentPage-1)},b}()}.call(this);var TEST=TEST||{};!function(a){function b(a){console.log("pdf render page",a),h=!0,f.getPage(a).then(function(c){var d=c.getViewport(j),e=document.createElement("canvas");e.height=d.height,e.width=d.width;var f={canvasContext:e.getContext("2d"),viewport:d},g=c.render(f);g.promise.then(function(){h=!1,m[a-1]=e,null!==i&&(b(i),i=null)})})}function c(a){h?i=a:b(a)}function d(a){var b=m[a-1];return null==b?(console.log("null canvas"),setTimeout(function(){d(a)},100),!1):(k.width=b.width,k.height=b.height,l.drawImage(b,0,0),o.page_num.html(g),!0)}function e(a){PDFJS.getDocument(a).then(function(a){f=a,m=[],g=1,o.page_count.html(f.numPages),b(g),d(g),c(g+1)})}var f=null,g=1,h=!1,i=null,j=5,k=(document.getElementById("canvas-wrapper"),document.getElementById("the-canvas")),l=k.getContext("2d"),m=[];k.style.width="100%";var n=$("#pdf_pager"),o={prev:n.find(".prev"),next:n.find(".next"),page_num:n.find(".page_num"),page_count:n.find(".page_count")};o.prev.on("click",function(){g<=1||(g--,null==m[g-1]&&c(g),d(g))}),o.next.on("click",function(){g>=f.numPages||(g++,null==m[g-1]&&c(g),d(g),g+1<f.numPages&&null==m[g]&&c(g+1))}),a.load_pdf=e}(this),function(a,b,c,d,e){function f(a){switch(a.key){default:var b=p[a.key];if(null==b)break;b-n<0&&(b+=12),b-n>12&&(b-=12),b+=12*m,o[a.key]=b,k(b)}}function g(a){switch(a.key){case"q":12*m+n>=33&&m--;break;case"p":12*m+n<=84&&m++;break;case"g":12*m+n<95&&(n+=2),n>6&&(n-=12,m++);break;case"v":12*m+n<96&&n++,n>6&&(n-=12,m++);break;case"h":12*m+n>22&&(n-=2),n<-6&&(n+=12,m--);break;case"n":12*m+n>21&&n--,n<-6&&(n+=12,m--);break;default:var b=o[a.key];if(null==b)break;l(b),delete o[a.key]}}function h(a,f){switch(a){case 1:case 4:case 6:case 9:case 11:return f-d+",0 "+(f+d)+",0 "+(f+d)+","+c+" "+(f-d)+","+c;case 0:case 5:case 10:return f-e+d+",0 "+(f+e-d)+",0 "+(f+e-d)+","+c+" "+(f+e)+","+c+" "+(f+e)+","+b+" "+(f-e)+","+b+" "+(f-e)+","+c+" "+(f-e+d)+","+c;case 3:case 8:case-1:return f-e+",0 "+(f+e-d)+",0 "+(f+e-d)+","+c+" "+(f+e)+","+c+" "+(f+e)+","+b+" "+(f-e)+","+b;case 2:case 7:return f-e+d+",0 "+(f+e)+",0 "+(f+e)+","+b+" "+(f-e)+","+b+" "+(f-e)+","+c+" "+(f-e+d)+","+c;case-2:return f-e+",0 "+(f+e)+",0 "+(f+e)+","+b+" "+(f-e)+","+b;default:return""}}function i(){for(var a="",b=e,c=0;c<88;++c)0==c?type=-1:87==c?type=-2:type=c%12,a+='<polygon class="kb" data-piano-key-number="'+(21+c)+'" points="'+h(type,b)+'" style="fill:'+r[(c+9)%12]+';stroke:gray;stroke-width:1;fill-rule:odd;"></polygon>>',b+=e,2!=type&&7!=type||(b+=e);return a}function j(a){var b='<input type="radio" name="musicMode" value="single" checked>Single note<br>\n';for(var c in a){var d=MG.chord_class_label[a[c]];void 0!=d&&(b+='<input type="radio" name="musicMode" value="'+a[c]+'">'+d+"<br>\n")}return b}function k(a){if("undefined"==typeof q[a]){var b=$(":radio[name=musicMode]:checked").val();q[a]="single"==b?[0]:MG.chord_class[b],s=parseInt($("#amplitude").val()),q[a].forEach(function(b){if(!(a+b>108)){MIDI.noteOn(0,a+b,s);var c=$(".kb[data-piano-key-number="+(a+b)+"]"),d="#444";"white"==r[(a+b)%12]&&(d="#DDD"),c.css("fill",d)}})}}function l(a){"undefined"!=typeof q[a]&&(q[a].slice().forEach(function(b){a+b>108||(MIDI.noteOff(0,a+b),$(".kb[data-piano-key-number="+(a+b)+"]").css("fill",r[(a+b)%12]))}),delete q[a])}var m=5,n=0,o={},p=function(){var a={};return"awsedfujikol;".split("").forEach(function(b,c){a[b]=c}),a}(),q={},r=Array(12).fill(0).map(function(a,b){switch(b){case 1:case 3:case 6:case 8:case 10:return"black";default:return"white"}}),s=110;a.handlePianoKeyRelease=function(a){l(parseInt($(a.target).data("piano-key-number")))},a.handlePianoKeyPress=function(a){var b=parseInt($(a.target).data("piano-key-number"));k(b)},a.make_keyboard=i,a.make_modeboard=j,a.keyHandlers=[f,g]}(this,130,70,6,9),function(a){function b(a){if("undefined"==typeof f[a]){var b=parseInt($("#drum_amplitude").val());MIDI.noteOn(9,a,b),f[a]=a}}function c(a){"undefined"!=typeof f[a]&&delete f[a]}function d(a){"undefined"!=typeof g[a.key]&&b(g[a.key])}function e(a){"undefined"!=typeof g[a.key]&&c(g[a.key])}var f={},g={v:36,f:37,g:38,h:50,b:45,n:41,y:49,i:51,u:46,j:44,m:42};a.drumHandlers=[d,e]}(this);